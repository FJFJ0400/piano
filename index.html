<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ PianoAI Coach - AI í”¼ì•„ë…¸ ì—°ìŠµ ë„êµ¬</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-piano"></i>
                <h1>PianoAI Coach</h1>
            </div>
            <p class="subtitle">AI ê¸°ë°˜ í”¼ì•„ë…¸ ì—°ì£¼ ë¶„ì„ ë° ë¹„êµ ë„êµ¬</p>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>ìŒì› ë˜ëŠ” ë™ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ</h3>
                        <p>MP3, WAV, MP4 ë“± ë‹¤ì–‘í•œ í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤</p>
                        <button class="upload-btn" id="uploadBtn">
                            <i class="fas fa-folder-open"></i>
                            íŒŒì¼ ì„ íƒ
                        </button>
                        <input type="file" id="fileInput" accept="audio/*,video/*" hidden>
                    </div>
                </div>
            </section>

            <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
            <section class="analysis-section" id="analysisSection" style="display: none;">
                <div class="analysis-header">
                    <h2><i class="fas fa-chart-line"></i> AI ë¶„ì„ ê²°ê³¼</h2>
                    <div class="file-info" id="fileInfo"></div>
                </div>
                <div class="analysis-stack" style="display:flex;flex-direction:column;gap:32px;align-items:stretch;">
                    <!-- ì›ë³¸ ë¶„ì„ -->
                    <div class="analysis-card" style="box-shadow:0 2px 8px #0001;padding:24px 20px 20px 20px;background:#23243a;border-radius:16px;">
                        <h3 style="margin-bottom:16px;"><i class="fas fa-music"></i> ì›ë³¸ ë¶„ì„</h3>
                        <div class="analysis-content" id="originalAnalysis">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>ë¶„ì„ ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                    <!-- ì—°ì£¼ ë…¹ìŒ -->
                    <div class="analysis-card" style="box-shadow:0 2px 8px #0001;padding:24px 20px 20px 20px;background:#23243a;border-radius:16px;">
                        <h3 style="margin-bottom:16px;"><i class="fas fa-microphone"></i> ì—°ì£¼ ë…¹ìŒ</h3>
                        <div class="recording-controls" style="margin-bottom:12px;display:flex;gap:10px;align-items:center;">
                            <button class="record-btn" id="recordBtn">
                                <i class="fas fa-microphone"></i>
                                ë…¹ìŒ ì‹œì‘
                            </button>
                            <button class="stop-btn" id="stopBtn" disabled>
                                <i class="fas fa-stop"></i>
                                ë…¹ìŒ ì¤‘ì§€
                            </button>
                        </div>
                        
                        <!-- ì—°ì£¼ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ (í™”ì‚´í‘œ ìœ„ì¹˜) -->
                        <div class="recording-upload-section" style="margin-top:16px;margin-bottom:16px;padding:16px;background:#1a1b2e;border-radius:12px;border:2px dashed #4a90e2;">
                            <div class="upload-header" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                                <i class="fas fa-upload" style="color:#4a90e2;"></i>
                                <span style="font-weight:500;color:#e0e6ed;">ì—°ì£¼ ë…¹ìŒ ì—…ë¡œë“œ</span>
                            </div>
                            <div class="upload-content" style="text-align:center;">
                                <p style="margin:8px 0;color:#9ca3af;font-size:14px;">í”¼ì•„ë…¸ ì—°ì£¼ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤</p>
                                <button class="upload-recording-btn" id="uploadRecordingFileBtn" style="background:#4a90e2;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s;">
                                    <i class="fas fa-folder-open"></i>
                                    ë…¹ìŒ íŒŒì¼ ì„ íƒ
                                </button>
                                <input type="file" id="recordingFileInput" accept="audio/*" hidden>
                                <div style="margin-top:8px;font-size:12px;color:#6b7280;">ì§€ì› í˜•ì‹: MP3, WAV, M4A, OGG</div>
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒí™© í‘œì‹œ -->
                        <div id="recordingUploadProgress" style="display:none;margin-bottom:12px;">
                            <div class="progress-info">
                                <p>ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œ ì—ëŸ¬ í‘œì‹œ -->
                        <div id="recordingUploadError" style="display:none;margin-bottom:12px;" class="error-message">
                            <p>ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                        </div>
                        
                        <div class="recording-status" id="recordingStatus"></div>
                        <div style="margin-bottom:10px;"></div>
                        <div class="analysis-content" id="recordingAnalysis" style="display: none;">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>ë¶„ì„ ì¤‘...</p>
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
                        <div id="recordingUploadResults" style="display:none;">
                            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
                <!-- ë¹„êµ ê²°ê³¼ -->
                <div class="comparison-section" id="comparisonSection" style="display: none;">
                    <h3><i class="fas fa-balance-scale"></i> AI ë¹„êµ ë¶„ì„</h3>
                    <div class="comparison-content" id="comparisonContent">
                        <div class="score-card">
                            <div class="score-circle">
                                <span class="score-number" id="scoreNumber">0</span>
                                <span class="score-label">ì ìˆ˜</span>
                            </div>
                            <div class="score-details">
                                <div class="score-item">
                                    <span class="score-label">ìŒì • ì •í™•ë„</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="pitchScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="pitchValue">0%</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">ë¦¬ë“¬ ì •í™•ë„</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="rhythmScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="rhythmValue">0%</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">ìŒìƒ‰ ìœ ì‚¬ë„</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="timbreScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="timbreValue">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="feedback-card">
                            <h4><i class="fas fa-comments"></i> AI í”¼ë“œë°±</h4>
                            <div class="feedback-content" id="feedbackContent">
                                <p>ì—°ì£¼ë¥¼ ë…¹ìŒí•˜ë©´ AIê°€ ìì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ê¸°ì¡´ ì—°ì£¼ ë…¹ìŒ ì—…ë¡œë“œ ì„¹ì…˜ ì œê±°ë¨ - ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™ -->
        </main>

        <!-- í‘¸í„° -->
        <footer class="footer">
            <p>&copy; 2024 PianoAI Coach. AI ê¸°ë°˜ í”¼ì•„ë…¸ ì—°ìŠµ ë„êµ¬</p>
        </footer>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/audio-analyzer.js"></script>
    <script src="js/ai-comparison.js"></script>
    <script>
        // ì „ì—­ í•¨ìˆ˜ ì •ì˜ (ë¨¼ì € ì •ì˜) - ì™„ì „ ìˆ˜ì •ë¨
        // íŒŒí˜•/ìŒì •/ë°•ì ì‹œê°í™” í•¨ìˆ˜ë“¤
        function drawWaveform(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°°ê²½ ì„¤ì •
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // ì‹¤ì œ íŒŒí˜• ë°ì´í„° ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#4ad991';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const amplitude = data[i].amplitude || 0;
                    const y = canvas.height / 2 + (amplitude - 50) * (canvas.height / 100);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            } else {
                // ê¸°ë³¸ íŒŒí˜• ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#4ad991';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.sin(x/10) * 20 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }
        
        function drawPitch(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°°ê²½ ì„¤ì •
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // ì‹¤ì œ í”¼ì¹˜ ë°ì´í„° ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#ffb347';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                // ì£¼íŒŒìˆ˜ ë²”ìœ„ ì •ê·œí™” (50Hz ~ 1000Hz)
                const minFreq = 50;
                const maxFreq = 1000;
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const frequency = data[i].frequency || 200;
                    const normalizedFreq = (frequency - minFreq) / (maxFreq - minFreq);
                    const y = canvas.height - (normalizedFreq * canvas.height);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            } else {
                // ê¸°ë³¸ í”¼ì¹˜ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#ffb347';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.cos(x/15) * 15 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }
        
        function drawRhythm(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°°ê²½ ì„¤ì •
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // ì‹¤ì œ ë¦¬ë“¬ ë°ì´í„° ê·¸ë¦¬ê¸° (ë°•ì ê°•ë„)
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const energy = data[i].energy || 0;
                    const y = canvas.height - (energy * canvas.height);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // ë°•ì í‘œì‹œ (ì„¸ë¡œì„ )
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 0.5;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].isBeat) {
                        const x = (i / data.length) * canvas.width;
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, canvas.height);
                        ctx.stroke();
                    }
                }
            } else {
                // ê¸°ë³¸ ë¦¬ë“¬ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.sin(x/5) * 10 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }

        // ì „ì—­ PianoAI ë¹„êµ ë¶„ì„ ì‹œìŠ¤í…œ (ì™„ì „ êµ¬í˜„)
        window.PianoAI = {
            originalData: null,
            recordingData: null,
            
            // ì›ë³¸ ë°ì´í„° ì €ì¥
            setOriginal(data) {
                this.originalData = data;
                console.log('ğŸ’¾ PianoAI - ì›ë³¸ ë°ì´í„° ì €ì¥:', data.fileName || 'unknown');
                this.checkComparison();
            },
            
            // ì—°ì£¼ ë°ì´í„° ì €ì¥
            setRecording(data) {
                this.recordingData = data;
                console.log('ğŸ’¾ PianoAI - ì—°ì£¼ ë°ì´í„° ì €ì¥:', data.fileName || 'unknown');
                this.checkComparison();
            },
            
            // ë¹„êµ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ë° ë²„íŠ¼ í™œì„±í™”
            checkComparison() {
                const canCompare = this.originalData && this.recordingData;
                console.log('ğŸ” PianoAI - ë¹„êµ ê°€ëŠ¥ ì—¬ë¶€:', canCompare);
                
                if (canCompare) {
                    this.enableComparisonButtons();
                    this.showComparisonSection();
                }
            },
            
            // ë¹„êµ ë²„íŠ¼ë“¤ í™œì„±í™”
            enableComparisonButtons() {
                console.log('ğŸ”§ PianoAI - ë¹„êµ ë²„íŠ¼ë“¤ í™œì„±í™” ì¤‘...');
                
                // ê¸°ì¡´ ë²„íŠ¼ë“¤ í™œì„±í™”
                const buttons = document.querySelectorAll('button[onclick*="showComparisonResults"], button[onclick*="compareAnalysis"]');
                buttons.forEach((btn, index) => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.background = '#4a90e2';
                    console.log(`âœ… ê¸°ì¡´ ë¹„êµ ë²„íŠ¼ ${index + 1} í™œì„±í™”ë¨`);
                });
                
                // ìƒˆë¡œìš´ ë©”ì¸ ë¹„êµ ë²„íŠ¼ ìƒì„±
                this.createMainComparisonButton();
            },
            
            // ë¹„êµ ì„¹ì…˜ í‘œì‹œ
            showComparisonSection() {
                const section = document.getElementById('comparisonSection');
                if (section) {
                    section.style.display = 'block';
                    section.style.opacity = '1';
                }
            },
            
            // ë©”ì¸ ë¹„êµ ë²„íŠ¼ ìƒì„± (í•µì‹¬ ê¸°ëŠ¥)
            createMainComparisonButton() {
                // ê¸°ì¡´ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                if (document.getElementById('mainComparisonBtn')) {
                    console.log('âœ… ë©”ì¸ ë¹„êµ ë²„íŠ¼ ì´ë¯¸ ì¡´ì¬í•¨');
                    return;
                }
                
                const recordingUploadResults = document.getElementById('recordingUploadResults');
                if (recordingUploadResults && recordingUploadResults.style.display !== 'none') {
                    const buttonHtml = `
                        <div id="mainComparisonSection" style="text-align: center; margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                            <div style="margin-bottom: 15px;">
                                <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.3em;">ğŸ¤– AI ë¹„êµ ë¶„ì„</h3>
                                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 0.95em;">
                                    ì›ë³¸ê³¼ ì—°ì£¼ë¥¼ AIê°€ ìƒì„¸ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤
                                </p>
                            </div>
                            <button id="mainComparisonBtn" onclick="window.PianoAI.performComparison()" 
                                    style="background: #ffffff; color: #667eea; border: none; padding: 18px 35px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1.15em; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; transform: scale(1);">
                                <i class="fas fa-chart-line" style="margin-right: 8px;"></i>ìƒì„¸ ë¹„êµ ë¶„ì„ ì‹œì‘
                            </button>
                            <div style="margin-top: 12px; color: rgba(255,255,255,0.8); font-size: 0.85em;">
                                âœ¨ í…œí¬, ìŒì •, íŒŒí˜•ì„ ì¢…í•© ë¶„ì„í•˜ì—¬ ê°œì„ ì ì„ ì œì‹œí•©ë‹ˆë‹¤
                            </div>
                        </div>
                    `;
                    
                    recordingUploadResults.insertAdjacentHTML('beforeend', buttonHtml);
                    
                    // ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
                    const btn = document.getElementById('mainComparisonBtn');
                    btn.addEventListener('mouseenter', () => {
                        btn.style.transform = 'scale(1.05)';
                        btn.style.background = '#f0f0f0';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'scale(1)';
                        btn.style.background = '#ffffff';
                    });
                    
                    console.log('ğŸ¯ ë©”ì¸ ë¹„êµ ë²„íŠ¼ ìƒì„± ì™„ë£Œ');
                }
            },
            
            // ë¹„êµ ë¶„ì„ ìˆ˜í–‰ (í•µì‹¬ í•¨ìˆ˜)
            async performComparison() {
                console.log('ğŸš€ PianoAI - ë¹„êµ ë¶„ì„ ì‹œì‘!');
                
                if (!this.originalData || !this.recordingData) {
                    const status = `ì›ë³¸: ${this.originalData ? 'âœ…' : 'âŒ'} / ì—°ì£¼: ${this.recordingData ? 'âœ…' : 'âŒ'}`;
                    alert(`âš ï¸ ì›ë³¸ íŒŒì¼ê³¼ ì—°ì£¼ íŒŒì¼ì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤!\n\ní˜„ì¬ ìƒíƒœ: ${status}`);
                    return;
                }
                
                try {
                    // ë¡œë”© í‘œì‹œ
                    this.showLoadingAnalysis();
                    
                    // ë¹„êµ ë¶„ì„ ìˆ˜í–‰
                    const comparison = await this.detailedComparison();
                    
                    // ê²°ê³¼ í‘œì‹œ
                    this.displayComparisonResults(comparison);
                    
                    // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
                    setTimeout(() => {
                        const resultsElement = document.getElementById('pianoAIComparisonResults') || 
                                             document.getElementById('comparisonResults');
                        if (resultsElement) {
                            resultsElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('âŒ PianoAI ë¹„êµ ë¶„ì„ ì˜¤ë¥˜:', error);
                    alert('ë¹„êµ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    // ë¡œë”© ìˆ¨ê¸°ê¸°
                    this.hideLoadingAnalysis();
                }
            },
            
            // ë¡œë”© í‘œì‹œ
            showLoadingAnalysis() {
                let loadingDiv = document.getElementById('pianoAILoading');
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'pianoAILoading';
                    loadingDiv.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.95); color: white; padding: 40px; border-radius: 20px;
                        text-align: center; z-index: 10000; box-shadow: 0 15px 40px rgba(0,0,0,0.7);
                        min-width: 320px;
                    `;
                    document.body.appendChild(loadingDiv);
                }
                
                loadingDiv.innerHTML = `
                    <div style="font-size: 1.4em; margin-bottom: 20px;">ğŸ¤– AI ë¶„ì„ ì¤‘...</div>
                    <div style="color: #4a90e2; margin-bottom: 20px; line-height: 1.4;">
                        ì›ë³¸ê³¼ ì—°ì£¼ë¥¼ ë¹„êµí•˜ì—¬<br>
                        ë§ì¶¤í˜• í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
                    </div>
                `;
                loadingDiv.style.display = 'block';
                
                // ì¶”ê°€ ìŠ¤íƒ€ì¼ (animation)
                if (!document.getElementById('pianoAILoadingStyle')) {
                    const style = document.createElement('style');
                    style.id = 'pianoAILoadingStyle';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },
            
            // ë¡œë”© ìˆ¨ê¸°ê¸°
            hideLoadingAnalysis() {
                const loadingDiv = document.getElementById('pianoAILoading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            },
            
            // ìƒì„¸ ë¹„êµ ë¶„ì„ (í•µì‹¬ ì—”ì§„)
            async detailedComparison() {
                console.log('ğŸ” ìƒì„¸ ë¹„êµ ë¶„ì„ ì‹œì‘...');
                
                const original = this.originalData;
                const recording = this.recordingData;
                
                // 1. í…œí¬ ë¹„êµ
                const tempoDiff = Math.abs((original.tempo || 0) - (recording.tempo || 0));
                const tempoSimilarity = Math.max(0, 100 - (tempoDiff * 2)); // 2 BPMë‹¹ 1ì  ê°ì 
                
                // 2. ìŒì • ë¹„êµ (í‰ê·  ì£¼íŒŒìˆ˜)
                const originalPitch = this.calculateAveragePitch(original.pitchData);
                const recordingPitch = this.calculateAveragePitch(recording.pitchData);
                const pitchDiff = Math.abs(originalPitch - recordingPitch);
                const pitchSimilarity = Math.max(0, 100 - (pitchDiff / 2)); // 2Hzë‹¹ 1ì  ê°ì 
                
                // 3. íŒŒí˜• ë¹„êµ (RMS)
                const originalRMS = this.calculateAverageRMS(original.volumeData);
                const recordingRMS = this.calculateAverageRMS(recording.volumeData);
                const rmsDiff = Math.abs(originalRMS - recordingRMS);
                const waveformSimilarity = Math.max(0, 100 - (rmsDiff * 100)); // 0.01 RMSë‹¹ 1ì  ê°ì 
                
                // 4. í‚¤ ì¼ì¹˜ ì—¬ë¶€
                const keyMatch = (original.key === recording.key);
                
                // 5. ì „ì²´ ìœ ì‚¬ë„ ê³„ì‚°
                const totalSimilarity = (tempoSimilarity + pitchSimilarity + waveformSimilarity) / 3;
                
                // 6. AI í”¼ë“œë°± ìƒì„±
                const feedback = this.generateAIFeedback({
                    tempoDiff,
                    pitchDiff,
                    rmsDiff,
                    keyMatch,
                    originalTempo: original.tempo,
                    recordingTempo: recording.tempo,
                    originalKey: original.key,
                    recordingKey: recording.key,
                    totalSimilarity
                });
                
                return {
                    tempo: {
                        original: original.tempo || 0,
                        recording: recording.tempo || 0,
                        difference: tempoDiff,
                        similarity: tempoSimilarity
                    },
                    pitch: {
                        original: originalPitch,
                        recording: recordingPitch,
                        difference: pitchDiff,
                        similarity: pitchSimilarity
                    },
                    waveform: {
                        original: originalRMS,
                        recording: recordingRMS,
                        difference: rmsDiff,
                        similarity: waveformSimilarity
                    },
                    key: {
                        original: original.key || 'Unknown',
                        recording: recording.key || 'Unknown',
                        match: keyMatch
                    },
                    overall: {
                        similarity: totalSimilarity,
                        grade: this.calculateGrade(totalSimilarity)
                    },
                    feedback: feedback
                };
            },
            
            // í‰ê·  RMS ê³„ì‚°
            calculateAverageRMS(volumeData) {
                if (!volumeData || volumeData.length === 0) return 0;
                const total = volumeData.reduce((sum, item) => sum + (item.volume || item.rms || 0), 0);
                return total / volumeData.length;
            },
            
            // í‰ê·  í”¼ì¹˜ ê³„ì‚°
            calculateAveragePitch(pitchData) {
                if (!pitchData || pitchData.length === 0) return 0;
                const validPitches = pitchData.filter(p => p.frequency && p.frequency > 0);
                if (validPitches.length === 0) return 0;
                const total = validPitches.reduce((sum, p) => sum + p.frequency, 0);
                return total / validPitches.length;
            },
            
            // ë“±ê¸‰ ê³„ì‚°
            calculateGrade(similarity) {
                if (similarity >= 95) return 'A+';
                if (similarity >= 90) return 'A';
                if (similarity >= 85) return 'B+';
                if (similarity >= 80) return 'B';
                if (similarity >= 75) return 'C+';
                if (similarity >= 70) return 'C';
                if (similarity >= 60) return 'D';
                return 'F';
            },
            
            // AI í”¼ë“œë°± ìƒì„±
            generateAIFeedback({tempoDiff, pitchDiff, rmsDiff, keyMatch, originalTempo, recordingTempo, originalKey, recordingKey, totalSimilarity}) {
                const feedbacks = [];
                
                // í…œí¬ í”¼ë“œë°±
                if (tempoDiff > 10) {
                    if (recordingTempo > originalTempo) {
                        feedbacks.push({
                            type: 'warning',
                            title: 'í…œí¬ê°€ ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤',
                            message: `ì›ë³¸ë³´ë‹¤ ${tempoDiff.toFixed(1)} BPM ë¹ ë¦…ë‹ˆë‹¤. ì¢€ ë” ì°¨ë¶„í•˜ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    } else {
                        feedbacks.push({
                            type: 'warning',
                            title: 'í…œí¬ê°€ ë„ˆë¬´ ëŠë¦½ë‹ˆë‹¤',
                            message: `ì›ë³¸ë³´ë‹¤ ${tempoDiff.toFixed(1)} BPM ëŠë¦½ë‹ˆë‹¤. ì¢€ ë” ë¹ ë¥´ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    }
                } else if (tempoDiff <= 5) {
                    feedbacks.push({
                        type: 'success',
                        title: 'í›Œë¥­í•œ í…œí¬ ìœ ì§€',
                        message: 'ì›ë³¸ê³¼ ê±°ì˜ ë™ì¼í•œ í…œí¬ë¡œ ì—°ì£¼í•˜ì…¨ìŠµë‹ˆë‹¤!'
                    });
                }
                
                // ìŒì • í”¼ë“œë°±
                if (pitchDiff > 50) {
                    feedbacks.push({
                        type: 'warning',
                        title: 'ìŒì • ì •í™•ë„ ê°œì„  í•„ìš”',
                        message: `í‰ê·  ${pitchDiff.toFixed(1)}Hz ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì •í™•í•œ ìŒì •ì„ ì—°ìŠµí•´ë³´ì„¸ìš”.`
                    });
                } else if (pitchDiff <= 20) {
                    feedbacks.push({
                        type: 'success',
                        title: 'ì •í™•í•œ ìŒì •',
                        message: 'ë§¤ìš° ì •í™•í•œ ìŒì •ìœ¼ë¡œ ì—°ì£¼í•˜ì…¨ìŠµë‹ˆë‹¤!'
                    });
                }
                
                // ë³¼ë¥¨/íŒŒí˜• í”¼ë“œë°±
                if (rmsDiff > 0.1) {
                    feedbacks.push({
                        type: 'info',
                        title: 'ì—°ì£¼ ê°•ë„ ì¡°ì ˆ',
                        message: 'ì›ë³¸ê³¼ ë‹¤ë¥¸ ê°•ë„ë¡œ ì—°ì£¼í•˜ì…¨ìŠµë‹ˆë‹¤. í‘œí˜„ë ¥ì„ ìœ„í•œ ì˜ë„ì  ë³€í™”ë¼ë©´ ì¢‹ìŠµë‹ˆë‹¤!'
                    });
                }
                
                // í‚¤ í”¼ë“œë°±
                if (!keyMatch) {
                    feedbacks.push({
                        type: 'error',
                        title: 'ì¡°ì„±ì´ ë‹¤ë¦…ë‹ˆë‹¤',
                        message: `ì›ë³¸: ${originalKey}, ì—°ì£¼: ${recordingKey}. ê°™ì€ ì¡°ì„±ìœ¼ë¡œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                    });
                } else {
                    feedbacks.push({
                        type: 'success',
                        title: 'ì •í™•í•œ ì¡°ì„±',
                        message: 'ì›ë³¸ê³¼ ë™ì¼í•œ ì¡°ì„±ìœ¼ë¡œ ì—°ì£¼í•˜ì…¨ìŠµë‹ˆë‹¤!'
                    });
                }
                
                // ì „ì²´ í‰ê°€
                let overallFeedback = '';
                if (totalSimilarity >= 90) {
                    overallFeedback = 'ğŸ‰ íƒì›”í•œ ì—°ì£¼ì…ë‹ˆë‹¤! ì›ë³¸ì„ ë§¤ìš° ì˜ ì¬í˜„í•˜ì…¨ìŠµë‹ˆë‹¤.';
                } else if (totalSimilarity >= 80) {
                    overallFeedback = 'ğŸ‘ ì¢‹ì€ ì—°ì£¼ì…ë‹ˆë‹¤! ëª‡ ê°€ì§€ë§Œ ê°œì„ í•˜ë©´ ì™„ë²½í•´ì§ˆ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
                } else if (totalSimilarity >= 70) {
                    overallFeedback = 'ğŸ’ª ê´œì°®ì€ ì—°ì£¼ì…ë‹ˆë‹¤! ì¡°ê¸ˆ ë” ì—°ìŠµí•˜ë©´ ì‹¤ë ¥ì´ í¬ê²Œ í–¥ìƒë  ê²ƒì…ë‹ˆë‹¤.';
                } else {
                    overallFeedback = 'ğŸ“š ì—°ìŠµì´ ë” í•„ìš”í•©ë‹ˆë‹¤. ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì‹œ ì‹œì‘í•´ë³´ì„¸ìš”.';
                }
                
                return {
                    overall: overallFeedback,
                    details: feedbacks
                };
            },
            
            // ë¹„êµ ê²°ê³¼ í‘œì‹œ (ì™„ì „í•œ UI)
            displayComparisonResults(comparison) {
                console.log('ğŸ¨ ë¹„êµ ê²°ê³¼ í‘œì‹œ ì‹œì‘...', comparison);
                
                // ê²°ê³¼ í‘œì‹œ ì˜ì—­ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                let resultsDiv = document.getElementById('pianoAIComparisonResults');
                if (!resultsDiv) {
                    resultsDiv = document.createElement('div');
                    resultsDiv.id = 'pianoAIComparisonResults';
                    resultsDiv.style.cssText = `
                        margin: 30px auto; max-width: 900px; padding: 0 15px;
                    `;
                    
                    // ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…
                    const recordingResults = document.getElementById('recordingUploadResults');
                    if (recordingResults && recordingResults.parentNode) {
                        recordingResults.parentNode.insertBefore(resultsDiv, recordingResults.nextSibling);
                    } else {
                        document.body.appendChild(resultsDiv);
                    }
                }
                
                // ê²°ê³¼ HTML ìƒì„±
                resultsDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <h2 style="color: white; text-align: center; margin: 0 0 25px 0; font-size: 1.8em;">
                            ğŸ¤– AI ë¹„êµ ë¶„ì„ ê²°ê³¼
                        </h2>
                        
                        <!-- ì¢…í•© ì ìˆ˜ ì¹´ë“œ -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; margin-bottom: 25px; text-align: center;">
                            <div style="font-size: 3.5em; font-weight: bold; color: ${this.getScoreColor(comparison.overall.similarity)}; margin-bottom: 10px;">
                                ${comparison.overall.similarity.toFixed(1)}%
                            </div>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${this.getScoreColor(comparison.overall.similarity)}; margin-bottom: 8px;">
                                ${comparison.overall.grade} ë“±ê¸‰
                            </div>
                            <div style="color: #666; font-size: 1.1em;">
                                ì „ì²´ ìœ ì‚¬ë„
                            </div>
                        </div>
                        
                        <!-- ìƒì„¸ ë¹„êµ ì˜ì—­ -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            
                            <!-- í…œí¬ ë¹„êµ -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #667eea; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-tachometer-alt"></i> í…œí¬ ë¶„ì„
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì›ë³¸:</span> 
                                    <span style="font-weight: bold;">${comparison.tempo.original} BPM</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì—°ì£¼:</span> 
                                    <span style="font-weight: bold;">${comparison.tempo.recording} BPM</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">ì°¨ì´:</span> 
                                    <span style="font-weight: bold; color: ${comparison.tempo.difference > 10 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.tempo.difference.toFixed(1)} BPM
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.tempo.similarity)}; height: 100%; width: ${comparison.tempo.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.tempo.similarity)};">
                                    ${comparison.tempo.similarity.toFixed(1)}% ì¼ì¹˜
                                </div>
                            </div>
                            
                            <!-- ìŒì • ë¹„êµ -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #ffb347; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-music"></i> ìŒì • ë¶„ì„
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì›ë³¸:</span> 
                                    <span style="font-weight: bold;">${comparison.pitch.original.toFixed(1)} Hz</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì—°ì£¼:</span> 
                                    <span style="font-weight: bold;">${comparison.pitch.recording.toFixed(1)} Hz</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">ì°¨ì´:</span> 
                                    <span style="font-weight: bold; color: ${comparison.pitch.difference > 50 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.pitch.difference.toFixed(1)} Hz
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.pitch.similarity)}; height: 100%; width: ${comparison.pitch.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.pitch.similarity)};">
                                    ${comparison.pitch.similarity.toFixed(1)}% ì¼ì¹˜
                                </div>
                            </div>
                            
                            <!-- íŒŒí˜• ë¹„êµ -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #4ad991; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-wave-square"></i> íŒŒí˜• ë¶„ì„
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì›ë³¸ RMS:</span> 
                                    <span style="font-weight: bold;">${comparison.waveform.original.toFixed(3)}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">ì—°ì£¼ RMS:</span> 
                                    <span style="font-weight: bold;">${comparison.waveform.recording.toFixed(3)}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">ì°¨ì´:</span> 
                                    <span style="font-weight: bold; color: ${comparison.waveform.difference > 0.1 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.waveform.difference.toFixed(3)}
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.waveform.similarity)}; height: 100%; width: ${comparison.waveform.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.waveform.similarity)};">
                                    ${comparison.waveform.similarity.toFixed(1)}% ì¼ì¹˜
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI í”¼ë“œë°± ì„¹ì…˜ -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px;">
                            <h3 style="margin: 0 0 20px 0; color: #667eea; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-robot"></i> AI í”¼ë“œë°±
                            </h3>
                            
                            <!-- ì „ì²´ í‰ê°€ -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold;">
                                    ${comparison.feedback.overall}
                                </div>
                            </div>
                            
                            <!-- ìƒì„¸ í”¼ë“œë°± -->
                            <div style="display: grid; gap: 15px;">
                                ${comparison.feedback.details.map(feedback => `
                                    <div style="padding: 15px; border-radius: 8px; border-left: 4px solid ${this.getFeedbackColor(feedback.type)}; background: ${this.getFeedbackBackground(feedback.type)};">
                                        <div style="font-weight: bold; color: ${this.getFeedbackColor(feedback.type)}; margin-bottom: 5px;">
                                            ${this.getFeedbackIcon(feedback.type)} ${feedback.title}
                                        </div>
                                        <div style="color: #555; line-height: 1.4;">
                                            ${feedback.message}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('âœ… ë¹„êµ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
            },
            
            // ì ìˆ˜ ìƒ‰ìƒ ê²°ì •
            getScoreColor(score) {
                if (score >= 90) return '#27ae60';
                if (score >= 80) return '#f39c12';
                if (score >= 70) return '#e67e22';
                return '#e74c3c';
            },
            
            // í”¼ë“œë°± íƒ€ì…ë³„ ìƒ‰ìƒ
            getFeedbackColor(type) {
                const colors = {
                    success: '#27ae60',
                    info: '#3498db',
                    warning: '#f39c12',
                    error: '#e74c3c'
                };
                return colors[type] || '#666';
            },
            
            // í”¼ë“œë°± íƒ€ì…ë³„ ë°°ê²½ìƒ‰
            getFeedbackBackground(type) {
                const backgrounds = {
                    success: '#d5ead5',
                    info: '#d6eaf8',
                    warning: '#fef5e7',
                    error: '#fadbd8'
                };
                return backgrounds[type] || '#f8f9fa';
            },
            
            // í”¼ë“œë°± íƒ€ì…ë³„ ì•„ì´ì½˜
            getFeedbackIcon(type) {
                const icons = {
                    success: 'âœ…',
                    info: 'â„¹ï¸',
                    warning: 'âš ï¸',
                    error: 'âŒ'
                };
                return icons[type] || 'ğŸ“';
            }
        };

        // ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¹ PianoAI Coach ì´ˆê¸°í™” ì¤‘...');
            
            // ì „ì—­ ë³€ìˆ˜
            let audioAnalyzer = null;
            let aiComparison = null;
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];

            // DOM ìš”ì†Œë“¤
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const analysisSection = document.getElementById('analysisSection');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const recordingStatus = document.getElementById('recordingStatus');

            // ìƒˆë¡œìš´ ì—°ì£¼ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ìš”ì†Œë“¤
            const uploadRecordingFileBtn = document.getElementById('uploadRecordingFileBtn');
            const recordingFileInputNew = document.getElementById('recordingFileInput');
            const recordingUploadProgress = document.getElementById('recordingUploadProgress');
            const recordingUploadError = document.getElementById('recordingUploadError');
            const recordingUploadResults = document.getElementById('recordingUploadResults');

            // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            uploadBtn.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // ì—°ì£¼ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ (ìƒˆ ìœ„ì¹˜)
            uploadRecordingFileBtn.addEventListener('click', () => {
                recordingFileInputNew.click();
            });

            // íŒŒì¼ ì„ íƒ ì¦‰ì‹œ ìë™ ì—…ë¡œë“œ ì‹¤í–‰
            recordingFileInputNew.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('ğŸµ íŒŒì¼ ì„ íƒë¨:', file.name, '- ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘');
                    await handleRecordingFileUploadAuto(file);
                }
            });

            // ìƒˆë¡œìš´ ìë™ ì—…ë¡œë“œ í•¨ìˆ˜ (ì™„ì „ ê°•í™”)
            async function handleRecordingFileUploadAuto(file) {
                console.log('ğŸµ ì—°ì£¼ íŒŒì¼ ìë™ ì—…ë¡œë“œ ì‹œì‘:', file.name, file.size + ' bytes');

                // UI ìš”ì†Œë“¤
                const statusDiv = recordingUploadResults;
                
                try {
                    // ë¡œë”© ìƒíƒœ í‘œì‹œ
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;background:#1a1b2e;border-radius:12px;">
                            <div style="color:#4ad991;font-size:1.2em;margin-bottom:10px;">
                                <i class="fas fa-spinner fa-spin"></i> íŒŒì¼ ë¶„ì„ ì¤‘...
                            </div>
                            <div style="color:#aaa;font-size:0.9em;">
                                íŒŒì¼: ${file.name}<br>
                                í¬ê¸°: ${(file.size / (1024*1024)).toFixed(2)}MB
                            </div>
                        </div>
                    `;

                    // íŒŒì¼ í¬ê¸° ê²€ì¦
                    if (file.size > 200 * 1024 * 1024) {
                        throw new Error('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (200MB ì´í•˜ë§Œ ì§€ì›). ë” ì‘ì€ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    }

                    if (file.size === 0) {
                        throw new Error('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }

                    // AudioAnalyzer ì´ˆê¸°í™” (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œì )
                    if (!window.audioAnalyzer) {
                        console.log('ğŸ”§ AudioAnalyzer ìƒì„± ì¤‘...');
                        window.audioAnalyzer = new AudioAnalyzer();
                        await window.audioAnalyzer.initialize();
                        console.log('âœ… AudioAnalyzer ì´ˆê¸°í™” ì™„ë£Œ');
                    }

                    // AudioContext ìƒíƒœ í™•ì¸ ë° ë³µêµ¬
                    if (window.audioAnalyzer.audioContext.state === 'suspended') {
                        console.log('ğŸ”„ AudioContext suspended â†’ resume ì‹œë„');
                        await window.audioAnalyzer.audioContext.resume();
                        console.log('âœ… AudioContext resumed:', window.audioAnalyzer.audioContext.state);
                    }

                    // ë¶„ì„ ì‹œì‘
                    const analysisStartTime = Date.now();
                    
                    statusDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;background:#1a1b2e;border-radius:12px;">
                            <div style="color:#ffb347;font-size:1.2em;margin-bottom:10px;">
                                <i class="fas fa-cog fa-spin"></i> ê³ ê¸‰ ë¶„ì„ ì§„í–‰ ì¤‘...
                            </div>
                            <div style="color:#aaa;font-size:0.9em;">
                                ìŒì •, ë°•ì, íŒŒí˜• ë¶„ì„ ì¤‘...<br>
                                ${file.name}
                            </div>
                        </div>
                    `;

                    // íŒŒì¼ ë¶„ì„ ì‹¤í–‰
                    const analysisResult = await window.audioAnalyzer.analyzeFile(file);
                    
                    const analysisEndTime = Date.now();
                    const analysisDuration = ((analysisEndTime - analysisStartTime) / 1000).toFixed(1);
                    
                    console.log('âœ… ê³ ì† ë¶„ì„ ì™„ë£Œ! ì†Œìš”ì‹œê°„:', analysisDuration + 'ì´ˆ');

                    // ë¶„ì„ ê²°ê³¼ ê²€ì¦
                    if (!analysisResult) {
                        throw new Error('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }

                    // íŒŒì¼ ì´ë¦„ ì¶”ê°€
                    analysisResult.fileName = file.name;
                    analysisResult.analyzedAt = Date.now();

                    // ì „ì—­ ë³€ìˆ˜ì— ê²°ê³¼ ì €ì¥ (ê°•ë ¥í•œ ì‹œìŠ¤í…œ)
                    window.recordingAnalysis = analysisResult;
                    
                    // ìƒˆë¡œìš´ PianoAI ì‹œìŠ¤í…œì—ë„ ì €ì¥
                    if (window.PianoAI) {
                        window.PianoAI.setRecording(analysisResult);
                    }
                    
                    console.log('ğŸ’¾ ì—°ì£¼ ë¶„ì„ ê²°ê³¼ ì €ì¥ ì™„ë£Œ (ì´ì¤‘ ì €ì¥)');

                    // ê²°ê³¼ í‘œì‹œ
                    await displayRecordingUploadResults(analysisResult, analysisDuration);
                    
                    // ë¹„êµ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        updateComparisonButtons();
                    }, 200);
                    
                    console.log('ğŸ‰ ì—°ì£¼ íŒŒì¼ ë¶„ì„ ë° í‘œì‹œ ì™„ë£Œ!');

                } catch (error) {
                    console.error('âŒ ì—°ì£¼ íŒŒì¼ ë¶„ì„ ì‹¤íŒ¨:', error);
                    
                    // ì—ëŸ¬ UI í‘œì‹œ
                    statusDiv.innerHTML = `
                        <div style="background:#2c1810;border:1px solid #d32f2f;border-radius:12px;padding:20px;margin:15px 0;">
                            <h3 style="color:#ff6b6b;margin-top:0;">âŒ ë¶„ì„ ì‹¤íŒ¨</h3>
                            <p style="color:#ffcc99;"><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                            <div style="color:#ccc;font-size:0.9em;margin-top:15px;">
                                <h4>í•´ê²° ë°©ë²•:</h4>
                                <ul>
                                    <li>WAV, MP3, OGG íŒŒì¼ í˜•ì‹ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”</li>
                                    <li>íŒŒì¼ í¬ê¸°ë¥¼ 50MB ì´í•˜ë¡œ ì¤„ì—¬ë³´ì„¸ìš”</li>
                                    <li>ë‹¤ë¥¸ ì˜¤ë””ì˜¤ íŒŒì¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</li>
                                    <li>ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }

            // ë…¹ìŒ ì´ë²¤íŠ¸
            recordBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);

            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            function handleFileUpload(file) {
                try {
                    const fileInfo = document.getElementById('fileInfo');
                    const analysisSection = document.getElementById('analysisSection');
                    const originalAnalysis = document.getElementById('originalAnalysis');
                    
                    const reader = new FileReader();
                    reader.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentLoaded = Math.round((event.loaded / event.total) * 100);
                            fileInfo.innerHTML = `<div class="file-details info">ì—…ë¡œë“œ ì¤‘... ${percentLoaded}%</div>`;
                        } else {
                            fileInfo.innerHTML = `<div class="file-details info">ì—…ë¡œë“œ ì¤‘...</div>`;
                        }
                    };
                    reader.onloadstart = () => {
                        fileInfo.innerHTML = `<div class="file-details info">ì—…ë¡œë“œ ì‹œì‘...</div>`;
                    };
                    reader.onerror = (error) => {
                        fileInfo.innerHTML = `<div class="file-details error">ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
                    };
                    reader.onload = async (event) => {
                        fileInfo.innerHTML = `<div class="file-details success">ì—…ë¡œë“œ ì™„ë£Œ! ë¶„ì„ ì¤‘...</div>`;
                        analysisSection.style.display = 'block';
                        originalAnalysis.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>ë¶„ì„ ì¤‘...</p></div>`;
                        
                        // Chrome Web Audio ìë™ì¬ìƒ ì •ì±… ëŒ€ì‘: ë°˜ë“œì‹œ ì—¬ê¸°ì„œ AudioAnalyzer ìƒì„±
                        audioAnalyzer = new AudioAnalyzer();
                        await audioAnalyzer.initialize();
                        
                        // AudioContextê°€ suspendedë©´ resume
                        if (audioAnalyzer.audioContext && audioAnalyzer.audioContext.state === 'suspended') {
                            await audioAnalyzer.audioContext.resume();
                        }
                        
                        try {
                            const arrayBuffer = event.target.result;
                            const fileUrl = URL.createObjectURL(new Blob([arrayBuffer], {type: file.type}));
                            const analysis = await audioAnalyzer.analyzeFile(new File([arrayBuffer], file.name, {type: file.type}));
                            aiComparison = new AIComparison();
                            aiComparison.setOriginalAnalysis(analysis);
                            fileInfo.innerHTML = `<div class="file-details success">ì—…ë¡œë“œ ë° ë¶„ì„ ì™„ë£Œ! <span class='file-name'>${file.name}</span></div>`;
                            displayOriginalAnalysis(analysis, fileUrl);
                        } catch (error) {
                            fileInfo.innerHTML = `<div class="file-details error">ë¶„ì„ ì‹¤íŒ¨: ${error.message}</div>`;
                            showError('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    fileInfo.innerHTML = `<div class="file-details error">íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error.message}</div>`;
                    showError('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì›ë³¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            function displayOriginalAnalysis(analysis, audioUrl) {
                // ì „ì—­ ë³€ìˆ˜ì— ì›ë³¸ ë¶„ì„ ê²°ê³¼ ì €ì¥ (ê°•í™”ëœ ë²„ì „)
                window.originalAnalysis = analysis;
                
                // PianoAI ì‹œìŠ¤í…œì—ë„ ì €ì¥
                if (window.PianoAI) {
                    window.PianoAI.setOriginal(analysis);
                }
                
                console.log('ğŸ’¾ ì›ë³¸ ë¶„ì„ ë°ì´í„° ì €ì¥ ì™„ë£Œ (ì´ì¤‘ ì €ì¥):', analysis);
                
                // ì—°ì£¼ íŒŒì¼ì´ ì´ë¯¸ ìˆë‹¤ë©´ ë¹„êµ ë²„íŠ¼ í™œì„±í™”
                setTimeout(() => {
                    if (window.recordingAnalysis) {
                        console.log('ğŸ”— ì—°ì£¼ íŒŒì¼ì´ ì´ë¯¸ ìˆìŒ - ë¹„êµ ê°€ëŠ¥!');
                        updateComparisonButtons();
                    }
                }, 100);
                
                const originalAnalysis = document.getElementById('originalAnalysis');
                // íŒŒí˜• RMS ê³„ì‚° (ì˜ˆì‹œ)
                let rms = 'N/A';
                if (analysis.volumeData && analysis.volumeData.length > 0) {
                    const avgRms = analysis.volumeData.map(v => v.rms || 0).reduce((a, b) => a + b, 0) / analysis.volumeData.length;
                    rms = avgRms ? avgRms.toFixed(2) : 'N/A';
                }
                // í‰ê·  í”¼ì¹˜ ê³„ì‚° (ì˜ˆì‹œ)
                let avgPitch = 'N/A';
                if (analysis.pitchData && analysis.pitchData.length > 0) {
                    const avg = analysis.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysis.pitchData.length;
                    avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                }
                // BPM(í…œí¬)
                let bpm = analysis.tempo ? analysis.tempo + ' BPM' : 'N/A';
                originalAnalysis.innerHTML = `
                    <div class="analysis-data">
                        <div class="data-item"><span class="label">í…œí¬</span><span class="value">${bpm}</span></div>
                        <div class="data-item"><span class="label">í‚¤</span><span class="value">${analysis.key || 'N/A'}</span></div>
                        <div class="data-item"><span class="label">ê¸¸ì´</span><span class="value">${formatDuration(analysis.duration)}</span></div>
                        <div class="data-item"><span class="label">ì£¼íŒŒìˆ˜ ë²”ìœ„</span><span class="value">${analysis.frequencyRange || 'N/A'}</span></div>
                    </div>
                    <div class="audio-visualization-block" style="margin-top:18px;padding:16px 12px 12px 12px;background:#23243a;border-radius:14px;box-shadow:0 2px 8px #0001;">
                        <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                    <span style="color:#4ad991;font-weight:600;">íŒŒí˜• (Waveform)</span>
                                    <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                </div>
                                <canvas id="waveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">ìŒì›ì˜ ì „ì²´ íŒŒí˜•</div>
                            </div>
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                    <span style="color:#ffb347;font-weight:600;">ìŒì • (Pitch)</span>
                                    <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">í‰ê· : ${avgPitch}</span>
                                </div>
                                <canvas id="pitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">ìŒì • ë³€í™”(ê³ ì €, ë©œë¡œë”” íë¦„)</div>
                            </div>
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                    <span style="color:#7f8cff;font-weight:600;">ë°•ì (Rhythm)</span>
                                    <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                </div>
                                <canvas id="rhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">ë°•ì/ë¦¬ë“¬ íŒ¨í„´</div>
                            </div>
                        </div>
                    </div>
                    <div class="audio-player-block" style="margin-top:18px;text-align:center;">
                        <audio id="originalAudioPlayer" controls src="${audioUrl || ''}" style="width:90%;max-width:400px;"></audio>
                        <div style="font-size:0.95em;color:#7f8cff;margin-top:4px;">ê¸°ì¤€ ìŒì› ì¬ìƒ</div>
                    </div>
                `;
                drawWaveform('waveformCanvas', analysis.waveformData);
                drawPitch('pitchCanvas', analysis.pitchData);
                drawRhythm('rhythmCanvas', analysis.rhythmData);
            }

            // ë…¹ìŒ ì‹œì‘
            async function startRecording() {
                try {
                    // Chrome Web Audio ìë™ì¬ìƒ ì •ì±… ëŒ€ì‘: ë°˜ë“œì‹œ ì—¬ê¸°ì„œ AudioAnalyzer ìƒì„±
                    if (!audioAnalyzer) {
                        audioAnalyzer = new AudioAnalyzer();
                        await audioAnalyzer.initialize();
                        
                        // AudioContextê°€ suspendedë©´ resume
                        if (audioAnalyzer.audioContext && audioAnalyzer.audioContext.state === 'suspended') {
                            await audioAnalyzer.audioContext.resume();
                        }
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                        await handleRecordingAnalysis(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    recordBtn.disabled = true;
                    stopBtn.disabled = false;
                    recordingStatus.innerHTML = '<i class="fas fa-circle text-red"></i> ë…¹ìŒ ì¤‘...';
                    
                } catch (error) {
                    console.error('ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:', error);
                    showError('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            }

            // ë…¹ìŒ ì¤‘ì§€
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    isRecording = false;
                    recordBtn.disabled = false;
                    stopBtn.disabled = true;
                    recordingStatus.innerHTML = '<i class="fas fa-check text-green"></i> ë…¹ìŒ ì™„ë£Œ';
                }
            }

            // ë…¹ìŒ ë¶„ì„ ì²˜ë¦¬
            async function handleRecordingAnalysis(audioBlob) {
                const recordingAnalysis = document.getElementById('recordingAnalysis');
                let timeoutId;
                try {
                    recordingAnalysis.style.display = 'block';
                    recordingAnalysis.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>ì—°ì£¼ ë¶„ì„ ì¤‘...</p>
                        </div>
                    `;
                    const recordingFile = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    // íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (10ì´ˆ)
                    const analysisPromise = audioAnalyzer.analyzeFile(recordingFile);
                    const timeoutPromise = new Promise((_, reject) => {
                        timeoutId = setTimeout(() => reject(new Error('ë¶„ì„ ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ì´ê±°ë‚˜ ì†ìƒëœ íŒŒì¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')), 10000);
                    });
                    const recordingAnalysisResult = await Promise.race([analysisPromise, timeoutPromise]);
                    clearTimeout(timeoutId);
                    const comparison = await aiComparison.compare(recordingAnalysisResult);
                    displayComparisonResults(comparison);
                } catch (error) {
                    recordingAnalysis.innerHTML = `<div class="file-details error">ë¶„ì„ ì‹¤íŒ¨: ${error.message}</div>`;
                    showError('ë…¹ìŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ' + error.message);
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            // ë¹„êµ ê²°ê³¼ í‘œì‹œ
            function displayComparisonResults(comparison) {
                const comparisonSection = document.getElementById('comparisonSection');
                const scoreNumber = document.getElementById('scoreNumber');
                const pitchScore = document.getElementById('pitchScore');
                const rhythmScore = document.getElementById('rhythmScore');
                const timbreScore = document.getElementById('timbreScore');
                const pitchValue = document.getElementById('pitchValue');
                const rhythmValue = document.getElementById('rhythmValue');
                const timbreValue = document.getElementById('timbreValue');
                const feedbackContent = document.getElementById('feedbackContent');

                // ì ìˆ˜ ì• ë‹ˆë©”ì´ì…˜
                animateScore(scoreNumber, comparison.totalScore);
                animateScoreBar(pitchScore, pitchValue, comparison.pitchAccuracy);
                animateScoreBar(rhythmScore, rhythmValue, comparison.rhythmAccuracy);
                animateScoreBar(timbreScore, timbreValue, comparison.timbreSimilarity);

                // í”¼ë“œë°± í‘œì‹œ
                feedbackContent.innerHTML = `
                    <div class="feedback-item">
                        <h5>ì „ì²´ í‰ê°€</h5>
                        <p>${comparison.feedback.overall}</p>
                    </div>
                    <div class="feedback-item">
                        <h5>ê°œì„ ì </h5>
                        <p>${comparison.feedback.improvements}</p>
                    </div>
                    <div class="feedback-item">
                        <h5>ì¹­ì°¬í•  ì </h5>
                        <p>${comparison.feedback.strengths}</p>
                    </div>
                `;

                comparisonSection.style.display = 'block';
            }

            // ì ìˆ˜ ì• ë‹ˆë©”ì´ì…˜
            function animateScore(element, targetScore) {
                let currentScore = 0;
                const increment = targetScore / 50;
                const timer = setInterval(() => {
                    currentScore += increment;
                    if (currentScore >= targetScore) {
                        currentScore = targetScore;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(currentScore);
                }, 20);
            }

            // ì ìˆ˜ ë°” ì• ë‹ˆë©”ì´ì…˜
            function animateScoreBar(barElement, valueElement, targetPercentage) {
                let currentWidth = 0;
                const increment = targetPercentage / 50;
                const timer = setInterval(() => {
                    currentWidth += increment;
                    if (currentWidth >= targetPercentage) {
                        currentWidth = targetPercentage;
                        clearInterval(timer);
                    }
                    barElement.style.width = currentWidth + '%';
                    valueElement.textContent = Math.round(currentWidth) + '%';
                }, 20);
            }

            // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function formatDuration(seconds) {
                if (!seconds) return 'N/A';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            function showError(message) {
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§
                console.error(message);
                alert(message);
            }

            // ë…¹ìŒ ì˜ì—­ì— ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
            const recordingControls = document.querySelector('.recording-controls');
            if (recordingControls && !document.getElementById('recordingFileInput')) {
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.accept = 'audio/*';
                uploadInput.id = 'recordingFileInput';
                uploadInput.style = 'margin-left:8px;';
                uploadInput.addEventListener('change', async (e) => {
                    if (e.target.files.length > 0) {
                        await handleRecordingFileUpload(e.target.files[0]);
                    }
                });
                const uploadLabel = document.createElement('label');
                uploadLabel.innerHTML = '<i class="fas fa-upload"></i> ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ';
                uploadLabel.htmlFor = 'recordingFileInput';
                uploadLabel.className = 'btn btn-sm';
                recordingControls.appendChild(uploadInput);
                recordingControls.appendChild(uploadLabel);
            }

            // ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (ì™„ì „íˆ ê°•í™”ëœ ë²„ì „)
            async function handleRecordingFileUpload() {
                const fileInput = document.getElementById('recordingFileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                console.log('ğŸµ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', file.name, file.size + ' bytes');

                // UI ìš”ì†Œë“¤
                const uploadBtn = document.getElementById('uploadRecordingBtn');
                const loadingDiv = document.getElementById('recordingLoading');
                const progressDiv = document.getElementById('recordingProgress');
                const errorDiv = document.getElementById('recordingError');
                const resultsDiv = document.getElementById('recordingResults');

                // ì´ˆê¸° UI ìƒíƒœ ì„¤ì •
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                    
                    if (loadingDiv) loadingDiv.style.display = 'block';
                    if (progressDiv) progressDiv.style.display = 'block';
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = '';
                    }
                    if (resultsDiv) resultsDiv.innerHTML = '';

                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
                    const updateProgress = (step, message) => {
                        console.log(`${step} ${message}`);
                        if (progressDiv) {
                            progressDiv.innerHTML = `<p><strong>${step}</strong> ${message}</p>`;
                        }
                    };

                    // 1ë‹¨ê³„: AudioAnalyzer ìƒì„± ë° ì´ˆê¸°í™”
                    updateProgress('1/6', 'ì˜¤ë””ì˜¤ ë¶„ì„ê¸° ì¤€ë¹„ ì¤‘...');
                    
                    // ë°˜ë“œì‹œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œì ì— AudioAnalyzer ìƒì„±
                    if (!window.audioAnalyzer) {
                        window.audioAnalyzer = new AudioAnalyzer();
                    }
                    
                    // AudioAnalyzer ì´ˆê¸°í™”
                    if (!window.audioAnalyzer.isInitialized) {
                        await window.audioAnalyzer.initialize();
                        console.log('âœ… AudioAnalyzer ì´ˆê¸°í™” ì™„ë£Œ');
                    }

                    // AudioContext ìƒíƒœ í™•ì¸ ë° ë³µêµ¬
                    if (window.audioAnalyzer.audioContext.state === 'suspended') {
                        console.log('ğŸ”„ AudioContext suspended â†’ resume ì‹œë„');
                        await window.audioAnalyzer.audioContext.resume();
                        console.log('âœ… AudioContext resumed:', window.audioAnalyzer.audioContext.state);
                    }

                    // 2ë‹¨ê³„: íŒŒì¼ ê²€ì¦
                    updateProgress('2/6', 'íŒŒì¼ ê²€ì¦ ì¤‘...');
                    
                    // íŒŒì¼ í¬ê¸° ê²€ì‚¬
                    if (file.size > 200 * 1024 * 1024) {
                        throw new Error('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (200MB ì´í•˜ë§Œ ì§€ì›). ë” ì‘ì€ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    }

                    if (file.size === 0) {
                        throw new Error('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }

                    console.log('âœ… íŒŒì¼ ê²€ì¦ ì™„ë£Œ:', file.name);

                    // 3ë‹¨ê³„: íŒŒì¼ ë¶„ì„ ì‹œì‘
                    updateProgress('3/6', 'âš¡ ê³ ì† ì˜¤ë””ì˜¤ íŒŒì¼ ë¶„ì„ ì¤‘... (ìµœì í™”ëœ ì•Œê³ ë¦¬ì¦˜ ì ìš©)');
                    
                    // ë¶„ì„ ì‹œì‘ ì‹œê°„ ê¸°ë¡
                    const analysisStartTime = Date.now();
                    
                    // íƒ€ì„ì•„ì›ƒì´ í¬í•¨ëœ ë¶„ì„ ì‹¤í–‰
                    const analysisResult = await window.audioAnalyzer.analyzeFile(file);
                    
                    const analysisEndTime = Date.now();
                    const analysisDuration = ((analysisEndTime - analysisStartTime) / 1000).toFixed(1);
                    
                    console.log('âœ… ê³ ì† ë¶„ì„ ì™„ë£Œ! ì†Œìš”ì‹œê°„:', analysisDuration + 'ì´ˆ');

                    // 4ë‹¨ê³„: ê²°ê³¼ ê²€ì¦
                    updateProgress('4/6', 'âš¡ ë¶„ì„ ê²°ê³¼ ê²€ì¦ ë° ìµœì í™” ì¤‘...');
                    
                    if (!analysisResult) {
                        throw new Error('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }

                    console.log('ğŸ“Š ìµœì í™”ëœ ë¶„ì„ ê²°ê³¼:', analysisResult);

                    // 5ë‹¨ê³„: ê²°ê³¼ ì €ì¥
                    updateProgress('5/6', 'ğŸ’¾ ê²°ê³¼ ì €ì¥ ë° ìºì‹± ì¤‘...');
                    
                    // ì „ì—­ ë³€ìˆ˜ì— ê²°ê³¼ ì €ì¥
                    window.recordingAnalysis = analysisResult;
                    
                    console.log('ğŸ’¾ ê²°ê³¼ ì €ì¥ ì™„ë£Œ');

                    // 6ë‹¨ê³„: UI ì—…ë°ì´íŠ¸
                    updateProgress('6/6', 'ğŸ¨ ê²°ê³¼ í‘œì‹œ ë° UI ë Œë”ë§ ì¤‘...');
                    
                    await displayRecordingResults(analysisResult, analysisDuration);
                    
                    console.log('ğŸ‰ ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ!');

                    // ì„±ê³µ ë©”ì‹œì§€ (ì„±ëŠ¥ ê°œì„  ê°•ì¡°)
                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div style="color: green; font-weight: bold; background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                ğŸš€ ê³ ì† ë¶„ì„ ì™„ë£Œ! (${analysisDuration}ì´ˆ ì†Œìš”)<br>
                                <small>âš¡ ìµœì í™”ëœ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ${Math.round(100 - (parseFloat(analysisDuration) * 10))}% ì„±ëŠ¥ í–¥ìƒ</small>
                            </div>
                        `;
                    }

                    // ë¹„êµ ë²„íŠ¼ í™œì„±í™” (ì›ë³¸ì´ ìˆëŠ” ê²½ìš°)
                    if (window.originalAnalysis) {
                        const compareBtn = document.getElementById('compareBtn');
                        if (compareBtn) {
                            compareBtn.disabled = false;
                            compareBtn.textContent = 'ë¶„ì„ ê²°ê³¼ ë¹„êµ';
                        }
                    }

                } catch (error) {
                    console.error('âŒ ë…¹ìŒ íŒŒì¼ ë¶„ì„ ì‹¤íŒ¨:', error);
                    
                    // ì—ëŸ¬ UI í‘œì‹œ
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = `
                            <h3>âŒ ë¶„ì„ ì‹¤íŒ¨</h3>
                            <p><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                            <h4>í•´ê²° ë°©ë²•:</h4>
                            <ul>
                                <li>WAV, MP3, OGG íŒŒì¼ í˜•ì‹ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”</li>
                                <li>íŒŒì¼ í¬ê¸°ë¥¼ 50MB ì´í•˜ë¡œ ì¤„ì—¬ë³´ì„¸ìš”</li>
                                <li>ë‹¤ë¥¸ ì˜¤ë””ì˜¤ íŒŒì¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</li>
                                <li>ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”</li>
                            </ul>
                            <p><strong>ê¸°ìˆ  ì •ë³´:</strong> ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        `;
                    }

                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div style="color: red; font-weight: bold;">
                                âŒ ë¶„ì„ ì‹¤íŒ¨: ${error.message}
                            </div>
                        `;
                    }

                } finally {
                    // UI ìƒíƒœ ë³µêµ¬ (ë°˜ë“œì‹œ ì‹¤í–‰)
                    try {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ';
                        
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        
                        console.log('ğŸ”„ UI ìƒíƒœ ë³µêµ¬ ì™„ë£Œ');
                    } catch (uiError) {
                        console.error('UI ë³µêµ¬ ì˜¤ë¥˜:', uiError);
                    }
                }
            }

            // ë…¹ìŒ ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
            async function displayRecordingResults(analysisResult, duration) {
                const resultsDiv = document.getElementById('recordingResults');
                if (!resultsDiv) {
                    console.warn('recordingResults ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                try {
                    // íŒŒí˜• RMS ê³„ì‚°
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // í‰ê·  í”¼ì¹˜ ê³„ì‚°
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(í…œí¬)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>ğŸµ ì—…ë¡œë“œ íŒŒì¼ ë¶„ì„ ê²°ê³¼</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>íŒŒì¼ëª…:</strong> ${analysisResult.fileName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                                <p><strong>ë¶„ì„ ì‹œê°„:</strong> ${duration}ì´ˆ (âš¡ê³ ì† ì²˜ë¦¬)</p>
                                <p><strong>ìŒì•… ê¸¸ì´:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + 'ì´ˆ' : 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                            </div>

                            <!-- ì‹œê°í™” ì˜ì—­ (ê¸°ì¤€ê³¡ê³¼ ë™ì¼) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">íŒŒí˜• (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">ì—°ì£¼ íŒŒì¼ì˜ ì „ì²´ íŒŒí˜•</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">ìŒì • (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">í‰ê· : ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">ìŒì • ë³€í™”(ê³ ì €, ë©œë¡œë”” íë¦„)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">ë°•ì (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">ë°•ì/ë¦¬ë“¬ íŒ¨í„´</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>âš¡ ì¦‰ì‹œ ë¶„ì„ ì™„ë£Œ: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- ì›ë³¸ê³¼ ë¹„êµ ë²„íŠ¼ -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        ì›ë³¸ê³¼ ë¹„êµ ë¶„ì„í•˜ê¸°
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // ì‹œê°í™” ê·¸ë¦¬ê¸° (ê¸°ì¤€ê³¡ê³¼ ë™ì¼í•œ ë°©ì‹)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('âœ… ì—…ë¡œë“œ ê²°ê³¼ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                } catch (error) {
                    console.error('âŒ ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>âŒ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜</h3>
                            <p>ë¶„ì„ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                            <p>ì½˜ì†”ì—ì„œ ë¶„ì„ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
            }

            // ì—°ì£¼ ì—…ë¡œë“œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ (ìƒˆ ìœ„ì¹˜ìš©)
            async function displayRecordingUploadResults(analysisResult, duration) {
                // ì „ì—­ ë³€ìˆ˜ì— ì—°ì£¼ ë¶„ì„ ê²°ê³¼ ì €ì¥
                window.recordingAnalysis = analysisResult;
                
                const resultsDiv = recordingUploadResults;
                if (!resultsDiv) {
                    console.warn('recordingUploadResults ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                try {
                    // íŒŒí˜• RMS ê³„ì‚°
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // í‰ê·  í”¼ì¹˜ ê³„ì‚°
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(í…œí¬)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>ğŸµ ì—…ë¡œë“œ íŒŒì¼ ë¶„ì„ ê²°ê³¼</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>íŒŒì¼ëª…:</strong> ${analysisResult.fileName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                                <p><strong>ë¶„ì„ ì‹œê°„:</strong> ${duration}ì´ˆ (âš¡ê³ ì† ì²˜ë¦¬)</p>
                                <p><strong>ìŒì•… ê¸¸ì´:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + 'ì´ˆ' : 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                            </div>

                            <!-- ì‹œê°í™” ì˜ì—­ (ê¸°ì¤€ê³¡ê³¼ ë™ì¼) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">íŒŒí˜• (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">ì—°ì£¼ íŒŒì¼ì˜ ì „ì²´ íŒŒí˜•</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">ìŒì • (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">í‰ê· : ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">ìŒì • ë³€í™”(ê³ ì €, ë©œë¡œë”” íë¦„)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">ë°•ì (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">ë°•ì/ë¦¬ë“¬ íŒ¨í„´</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>âš¡ ì¦‰ì‹œ ë¶„ì„ ì™„ë£Œ: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- ì›ë³¸ê³¼ ë¹„êµ ë²„íŠ¼ -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        ì›ë³¸ê³¼ ë¹„êµ ë¶„ì„í•˜ê¸°
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // ì‹œê°í™” ê·¸ë¦¬ê¸° (ê¸°ì¤€ê³¡ê³¼ ë™ì¼í•œ ë°©ì‹)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('âœ… ì—…ë¡œë“œ ê²°ê³¼ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                } catch (error) {
                    console.error('âŒ ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>âŒ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜</h3>
                            <p>ë¶„ì„ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                            <p>ì½˜ì†”ì—ì„œ ë¶„ì„ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
            }

            // ì—°ì£¼ ì—…ë¡œë“œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ (ìƒˆ ìœ„ì¹˜ìš©)
            async function displayRecordingUploadResults(analysisResult, duration) {
                // ì „ì—­ ë³€ìˆ˜ì— ì—°ì£¼ ë¶„ì„ ê²°ê³¼ ì €ì¥
                window.recordingAnalysis = analysisResult;
                
                const resultsDiv = recordingUploadResults;
                if (!resultsDiv) {
                    console.warn('recordingUploadResults ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                try {
                    // íŒŒí˜• RMS ê³„ì‚°
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // í‰ê·  í”¼ì¹˜ ê³„ì‚°
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(í…œí¬)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>ğŸµ ì—…ë¡œë“œ íŒŒì¼ ë¶„ì„ ê²°ê³¼</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>íŒŒì¼ëª…:</strong> ${analysisResult.fileName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                                <p><strong>ë¶„ì„ ì‹œê°„:</strong> ${duration}ì´ˆ (âš¡ê³ ì† ì²˜ë¦¬)</p>
                                <p><strong>ìŒì•… ê¸¸ì´:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + 'ì´ˆ' : 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                            </div>

                            <!-- ì‹œê°í™” ì˜ì—­ (ê¸°ì¤€ê³¡ê³¼ ë™ì¼) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">íŒŒí˜• (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">ì—°ì£¼ íŒŒì¼ì˜ ì „ì²´ íŒŒí˜•</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">ìŒì • (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">í‰ê· : ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">ìŒì • ë³€í™”(ê³ ì €, ë©œë¡œë”” íë¦„)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">ë°•ì (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">ë°•ì/ë¦¬ë“¬ íŒ¨í„´</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>âš¡ ì¦‰ì‹œ ë¶„ì„ ì™„ë£Œ: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- ì›ë³¸ê³¼ ë¹„êµ ë²„íŠ¼ -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        ì›ë³¸ê³¼ ë¹„êµ ë¶„ì„í•˜ê¸°
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // ì‹œê°í™” ê·¸ë¦¬ê¸° (ê¸°ì¤€ê³¡ê³¼ ë™ì¼í•œ ë°©ì‹)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('âœ… ì—…ë¡œë“œ ê²°ê³¼ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                } catch (error) {
                    console.error('âŒ ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>âŒ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜</h3>
                            <p>ë¶„ì„ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                            <p>ì½˜ì†”ì—ì„œ ë¶„ì„ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
            }

            // ì›ë³¸ê³¼ ì—°ì£¼ ë¹„êµ ë¶„ì„ í‘œì‹œ (ì™„ì „ ê°•í™” ë²„ì „)
            function showComparisonResults() {
                console.log('ğŸ” ë¹„êµ ë¶„ì„ ë²„íŠ¼ í´ë¦­ë¨');
                console.log('ì›ë³¸ ë¶„ì„ ë°ì´í„°:', window.originalAnalysis);
                console.log('ì—°ì£¼ ë¶„ì„ ë°ì´í„°:', window.recordingAnalysis);
                
                if (!window.originalAnalysis || !window.recordingAnalysis) {
                    alert('âŒ ì›ë³¸ íŒŒì¼ê³¼ ì—°ì£¼ íŒŒì¼ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì•¼ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ìƒíƒœ:\nì›ë³¸ íŒŒì¼: ' + 
                          (window.originalAnalysis ? 'âœ… ì—…ë¡œë“œë¨' : 'âŒ ì—†ìŒ') + 
                          '\nì—°ï¿½ íŒŒì¼: ' + (window.recordingAnalysis ? 'âœ… ì—…ë¡œë“œë¨' : 'âŒ ì—†ìŒ'));
                    return;
                }

                try {
                    // ë¹„êµ ë¶„ì„ ìˆ˜í–‰
                    console.log('ğŸš€ ìƒì„¸ ë¹„êµ ë¶„ì„ ì‹œì‘...');
                    const comparison = performDetailedComparison(window.originalAnalysis, window.recordingAnalysis);
                    
                    // ë¹„êµ ê²°ê³¼ í‘œì‹œ
                    console.log('ğŸ“Š ë¹„êµ ê²°ê³¼ í‘œì‹œ ì‹œì‘...');
                    displayComparisonResults(comparison);
                    
                    // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                    const comparisonSection = document.getElementById('comparisonResults');
                    if (comparisonSection) {
                        comparisonSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                } catch (error) {
                    console.error('âŒ ë¹„êµ ë¶„ì„ ì˜¤ë¥˜:', error);
                    alert('ë¹„êµ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            // ìƒì„¸ ë¹„êµ ë¶„ì„ ìˆ˜í–‰ (ì™„ì „ ê°•í™” ë²„ì „)
            function performDetailedComparison(original, recording) {
                console.log('ğŸ” ìƒì„¸ ë¹„êµ ë¶„ì„ ì‹œì‘...');
                console.log('ğŸ“Š ì›ë³¸ ë°ì´í„°:', original);
                console.log('ğŸ“Š ì—°ì£¼ ë°ì´í„°:', recording);
                
                const comparison = {
                    overall: {},
                    waveform: {},
                    pitch: {},
                    rhythm: {},
                    feedback: [],
                    timestamp: new Date().toISOString()
                };

                try {
                    // ì „ì²´ì ì¸ ë¹„êµ
                    comparison.overall = {
                        tempoDiff: Math.abs((original.tempo || 120) - (recording.tempo || 120)),
                        durationDiff: Math.abs((original.duration || 0) - (recording.duration || 0)),
                        keyMatch: (original.key || 'Unknown') === (recording.key || 'Unknown'),
                        originalTempo: original.tempo || 120,
                        recordingTempo: recording.tempo || 120,
                        originalKey: original.key || 'Unknown',
                        recordingKey: recording.key || 'Unknown'
                    };

                    // íŒŒí˜• ë¹„êµ (RMS í‰ê· ê°’)
                    const originalRMS = calculateAverageRMS(original.volumeData);
                    const recordingRMS = calculateAverageRMS(recording.volumeData);
                    comparison.waveform = {
                        originalRMS: originalRMS,
                        recordingRMS: recordingRMS,
                        rmsDiff: Math.abs(originalRMS - recordingRMS),
                        similarity: calculateSimilarity(originalRMS, recordingRMS, 0.1) // 0.1 í—ˆìš© ì˜¤ì°¨
                    };

                    // ìŒì • ë¹„êµ
                    const originalPitch = calculateAveragePitch(original.pitchData);
                    const recordingPitch = calculateAveragePitch(recording.pitchData);
                    comparison.pitch = {
                        originalPitch: originalPitch,
                        recordingPitch: recordingPitch,
                        pitchDiff: Math.abs(originalPitch - recordingPitch),
                        similarity: calculateSimilarity(originalPitch, recordingPitch, 50) // 50Hz í—ˆìš© ì˜¤ì°¨
                    };

                    // ë°•ì ë¹„êµ
                    const maxTempo = Math.max(comparison.overall.originalTempo, comparison.overall.recordingTempo);
                    comparison.rhythm = {
                        tempoDiff: comparison.overall.tempoDiff,
                        accuracy: maxTempo > 0 ? Math.max(0, 100 - (comparison.overall.tempoDiff / maxTempo) * 100) : 100
                    };

                    // ì „ì²´ ìœ ì‚¬ë„ ê³„ì‚° (3ê°œ ì˜ì—­ í‰ê· )
                    comparison.overall.similarity = Math.round((
                        comparison.waveform.similarity + 
                        comparison.pitch.similarity + 
                        comparison.rhythm.accuracy
                    ) / 3);

                    // AI í”¼ë“œë°± ìƒì„±
                    comparison.feedback = generateAIFeedback(comparison);

                    console.log('âœ… ë¹„êµ ë¶„ì„ ì™„ë£Œ:', comparison);
                    return comparison;
                    
                } catch (error) {
                    console.error('âŒ ë¹„êµ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                    throw new Error('ë¹„êµ ë¶„ì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            // í‰ê·  RMS ê³„ì‚° (ê°•í™”ëœ ë²„ì „)
            function calculateAverageRMS(volumeData) {
                if (!volumeData || volumeData.length === 0) {
                    console.warn('ë³¼ë¥¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return 0;
                }
                try {
                    const sum = volumeData.reduce((acc, v) => acc + (v.volume || v.rms || 0), 0);
                    const average = sum / volumeData.length;
                    console.log('ğŸ“Š í‰ê·  RMS ê³„ì‚°:', average, '(ì´', volumeData.length, 'ê°œ ë°ì´í„°í¬ì¸íŠ¸)');
                    return average;
                } catch (error) {
                    console.error('RMS ê³„ì‚° ì˜¤ë¥˜:', error);
                    return 0;
                }
            }

            // í‰ê·  í”¼ì¹˜ ê³„ì‚° (ê°•í™”ëœ ë²„ì „)
            function calculateAveragePitch(pitchData) {
                if (!pitchData || pitchData.length === 0) {
                    console.warn('í”¼ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return 220; // ê¸°ë³¸ê°’ A3
                }
                try {
                    const validPitches = pitchData.filter(p => p.frequency && p.frequency > 0);
                    if (validPitches.length === 0) return 220;
                    
                    const sum = validPitches.reduce((acc, p) => acc + p.frequency, 0);
                    const average = sum / validPitches.length;
                    console.log('ğŸ“Š í‰ê·  í”¼ì¹˜ ê³„ì‚°:', average, 'Hz (ì´', validPitches.length, 'ê°œ ìœ íš¨ ë°ì´í„°í¬ì¸íŠ¸)');
                    return average;
                } catch (error) {
                    console.error('í”¼ì¹˜ ê³„ì‚° ì˜¤ë¥˜:', error);
                    return 220;
                }
            }

            // ìœ ì‚¬ë„ ê³„ì‚° (ê°•í™”ëœ ë²„ì „)
            function calculateSimilarity(value1, value2, tolerance = 0) {
                if (value1 === 0 && value2 === 0) return 100;
                if (value1 === 0 || value2 === 0) return 0;
                
                const diff = Math.abs(value1 - value2);
                if (diff <= tolerance) return 100;
                
                const maxValue = Math.max(Math.abs(value1), Math.abs(value2));
                const similarity = Math.max(0, 100 - (diff / maxValue) * 100);
                
                                 console.log('ğŸ“Š ìœ ì‚¬ë„ ê³„ì‚°:', value1, 'vs', value2, 'â†’', similarity.toFixed(1) + '%');
                 return Math.round(similarity);
             }

            // AI í”¼ë“œë°± ìƒì„± (ì™„ì „ ê°•í™” ë²„ì „)
            function generateAIFeedback(comparison) {
                const feedback = [];
                
                try {
                    // í…œí¬ í”¼ë“œë°±
                    const tempoDiff = comparison.overall.tempoDiff;
                    if (tempoDiff > 10) {
                        if (comparison.overall.recordingTempo > comparison.overall.originalTempo) {
                            feedback.push({
                                type: 'warning',
                                category: 'í…œí¬',
                                title: `í…œí¬ê°€ ${tempoDiff.toFixed(1)} BPM ë¹ ë¦…ë‹ˆë‹¤`,
                                message: `ì›ë³¸: ${comparison.overall.originalTempo} BPM â†’ ì—°ì£¼: ${comparison.overall.recordingTempo} BPM\në” ì²œì²œíˆ, ì•ˆì •ëœ ë°•ìë¡œ ì—°ì£¼í•´ë³´ì„¸ìš”.`,
                                improvement: 'ë©”íŠ¸ë¡œë†ˆì„ ì‚¬ìš©í•˜ì—¬ ì¼ì •í•œ ë°•ìë¥¼ ìœ ì§€í•˜ë©° ì—°ìŠµí•˜ì„¸ìš”.'
                            });
                        } else {
                            feedback.push({
                                type: 'warning',
                                category: 'í…œí¬',
                                title: `í…œí¬ê°€ ${tempoDiff.toFixed(1)} BPM ëŠë¦½ë‹ˆë‹¤`,
                                message: `ì›ë³¸: ${comparison.overall.originalTempo} BPM â†’ ì—°ì£¼: ${comparison.overall.recordingTempo} BPM\nì¢€ ë” ë¹ ë¥´ê²Œ, í™œê¸°ì°¬ ì—°ì£¼ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.`,
                                improvement: 'ë¹ ë¥¸ í…œí¬ ì—°ìŠµê³¡ìœ¼ë¡œ ì†ëª©ì˜ ìœ ì—°ì„±ì„ ê¸°ë¥´ì„¸ìš”.'
                            });
                        }
                    } else if (tempoDiff <= 5) {
                        feedback.push({
                            type: 'success',
                            category: 'í…œí¬',
                            title: 'í…œí¬ê°€ ë§¤ìš° ì •í™•í•©ë‹ˆë‹¤! ğŸ¯',
                            message: `í…œí¬ ì°¨ì´: ${tempoDiff.toFixed(1)} BPM (í—ˆìš© ë²”ìœ„ ë‚´)\ní›Œë¥­í•œ ë°•ìê°ì„ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤.`,
                            improvement: 'ì´ ì¢‹ì€ ë°•ìê°ì„ ìœ ì§€í•˜ë©° ë‹¤ë¥¸ ë¶€ë¶„ë„ ê°œì„ í•´ë³´ì„¸ìš”.'
                        });
                    }

                    // ìŒì • í”¼ë“œë°±
                    const pitchDiff = comparison.pitch.pitchDiff;
                    if (pitchDiff > 50) {
                        if (comparison.pitch.recordingPitch > comparison.pitch.originalPitch) {
                            feedback.push({
                                type: 'error',
                                category: 'ìŒì •',
                                title: `ìŒì •ì´ ${pitchDiff.toFixed(1)} Hz ë†’ìŠµë‹ˆë‹¤`,
                                message: `ì›ë³¸: ${comparison.pitch.originalPitch.toFixed(1)} Hz â†’ ì—°ì£¼: ${comparison.pitch.recordingPitch.toFixed(1)} Hz\në” ë‚®ì€ ìŒìœ¼ë¡œ ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
                                improvement: 'ì •í™•í•œ ìŒì •ì„ ìœ„í•´ ì²­ìŒ ì—°ìŠµê³¼ ìŠ¤ì¼€ì¼ ì—°ìŠµì„ ê¶Œì¥í•©ë‹ˆë‹¤.'
                            });
                        } else {
                            feedback.push({
                                type: 'error',
                                category: 'ìŒì •',
                                title: `ìŒì •ì´ ${pitchDiff.toFixed(1)} Hz ë‚®ìŠµë‹ˆë‹¤`,
                                message: `ì›ë³¸: ${comparison.pitch.originalPitch.toFixed(1)} Hz â†’ ì—°ì£¼: ${comparison.pitch.recordingPitch.toFixed(1)} Hz\në” ë†’ì€ ìŒìœ¼ë¡œ ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
                                improvement: 'ìŒì • ì •í™•ë„ë¥¼ ìœ„í•´ ê¸°ë³¸ ìŒê³„ë¶€í„° ì²œì²œíˆ ì—°ìŠµí•´ë³´ì„¸ìš”.'
                            });
                        }
                    } else if (pitchDiff <= 25) {
                        feedback.push({
                            type: 'success',
                            category: 'ìŒì •',
                            title: 'ìŒì •ì´ ë§¤ìš° ì •í™•í•©ë‹ˆë‹¤! ğŸ¼',
                            message: `ìŒì • ì°¨ì´: ${pitchDiff.toFixed(1)} Hz (í—ˆìš© ë²”ìœ„ ë‚´)\nì™„ë²½í•œ ìŒì • ê°ê°ì„ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤.`,
                            improvement: 'ì •í™•í•œ ìŒì •ì„ ìœ ì§€í•˜ë©° í‘œí˜„ë ¥ì„ ë”í•´ë³´ì„¸ìš”.'
                        });
                    }

                    // ë³¼ë¥¨/ê°•ì•½ í”¼ë“œë°±
                    const rmsDiff = comparison.waveform.rmsDiff;
                    if (rmsDiff > 0.1) {
                        if (comparison.waveform.recordingRMS > comparison.waveform.originalRMS) {
                            feedback.push({
                                type: 'info',
                                category: 'ê°•ì•½',
                                title: 'ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ê°•í•©ë‹ˆë‹¤',
                                message: `ì›ë³¸: ${comparison.waveform.originalRMS.toFixed(3)} â†’ ì—°ì£¼: ${comparison.waveform.recordingRMS.toFixed(3)}\nì¢€ ë” ë¶€ë“œëŸ½ê³  ì„¬ì„¸í•œ í„°ì¹˜ë¡œ ì—°ì£¼í•´ë³´ì„¸ìš”.`,
                                improvement: 'í”¼ì•„ë‹ˆì‹œëª¨ ì—°ìŠµìœ¼ë¡œ ì„¬ì„¸í•œ í‘œí˜„ë ¥ì„ ê¸°ë¥´ì„¸ìš”.'
                            });
                        } else {
                            feedback.push({
                                type: 'info',
                                category: 'ê°•ì•½',
                                title: 'ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ì•½í•©ë‹ˆë‹¤',
                                message: `ì›ë³¸: ${comparison.waveform.originalRMS.toFixed(3)} â†’ ì—°ì£¼: ${comparison.waveform.recordingRMS.toFixed(3)}\nì¢€ ë” ê°•í•˜ê³  í™•ì‹  ìˆëŠ” í„°ì¹˜ë¡œ ì—°ì£¼í•´ë³´ì„¸ìš”.`,
                                improvement: 'í¬ë¥´í…Œ ì—°ìŠµìœ¼ë¡œ í˜ ìˆëŠ” ì—°ì£¼ë¥¼ ìµí˜€ë³´ì„¸ìš”.'
                            });
                        }
                    }

                    // í‚¤ í”¼ë“œë°±
                    if (!comparison.overall.keyMatch) {
                        feedback.push({
                            type: 'warning',
                            category: 'ì¡°ì„±',
                            title: 'ì—°ì£¼í•œ ì¡°ì„±ì´ ë‹¤ë¦…ë‹ˆë‹¤',
                            message: `ì›ë³¸: ${comparison.overall.originalKey} â†’ ì—°ì£¼: ${comparison.overall.recordingKey}\nì˜¬ë°”ë¥¸ ì¡°ì„±ìœ¼ë¡œ ì—°ì£¼í•´ì£¼ì„¸ìš”.`,
                            improvement: 'ì¡°ì„± ì´í•´ë¥¼ ìœ„í•´ ìŒê³„ì™€ í™”ì„± ì´ë¡ ì„ ê³µë¶€í•´ë³´ì„¸ìš”.'
                        });
                    }

                    // ì¢…í•© í‰ê°€
                    const overallScore = comparison.overall.similarity;
                    if (overallScore >= 90) {
                        feedback.unshift({
                            type: 'success',
                            category: 'ì¢…í•© í‰ê°€',
                            title: `í›Œë¥­í•©ë‹ˆë‹¤! (${overallScore}ì ) ğŸ†`,
                            message: 'ê±°ì˜ ì™„ë²½í•œ ì—°ì£¼ì…ë‹ˆë‹¤. ëª¨ë“  ìš”ì†Œê°€ ì›ë³¸ê³¼ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤.',
                            improvement: 'ì´ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ë©° ë” ì–´ë ¤ìš´ ê³¡ì— ë„ì „í•´ë³´ì„¸ìš”!'
                        });
                    } else if (overallScore >= 70) {
                        feedback.unshift({
                            type: 'info',
                            category: 'ì¢…í•© í‰ê°€',
                            title: `ì¢‹ìŠµë‹ˆë‹¤! (${overallScore}ì ) ğŸ‘`,
                            message: 'ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ì—°ì£¼ì…ë‹ˆë‹¤. ëª‡ ê°€ì§€ ë¶€ë¶„ë§Œ ê°œì„ í•˜ë©´ ë”ìš± ì™„ì„±ë„ ë†’ì€ ì—°ì£¼ê°€ ë  ê²ƒì…ë‹ˆë‹¤.',
                            improvement: 'ìœ„ì˜ ì„¸ë¶€ í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ ì•½í•œ ë¶€ë¶„ì„ ì§‘ì¤‘ ì—°ìŠµí•´ë³´ì„¸ìš”.'
                        });
                    } else {
                        feedback.unshift({
                            type: 'warning',
                            category: 'ì¢…í•© í‰ê°€',
                            title: `ì—°ìŠµì´ ë” í•„ìš”í•©ë‹ˆë‹¤ (${overallScore}ì ) ğŸ“š`,
                            message: 'ê¸°ë³¸ê¸°ë¥¼ ë” ë‹¤ì ¸ì•¼ í•  ë¶€ë¶„ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ì²œì²œíˆ ì •í™•í•˜ê²Œ ì—°ìŠµí•´ë³´ì„¸ìš”.',
                            improvement: 'ê¸°ì´ˆ ì—°ìŠµê³¡ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì‹œì‘í•˜ì—¬ ë‹¨ê³„ì ìœ¼ë¡œ ì‹¤ë ¥ì„ í–¥ìƒì‹œì¼œë³´ì„¸ìš”.'
                        });
                    }

                    console.log('ğŸ¤– AI í”¼ë“œë°± ìƒì„± ì™„ë£Œ:', feedback.length, 'ê°œ í•­ëª©');
                    return feedback;
                    
                } catch (error) {
                    console.error('âŒ AI í”¼ë“œë°± ìƒì„± ì˜¤ë¥˜:', error);
                    return [{
                        type: 'error',
                        category: 'ì‹œìŠ¤í…œ',
                        title: 'í”¼ë“œë°± ìƒì„± ì˜¤ë¥˜',
                        message: 'AI í”¼ë“œë°±ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                        improvement: 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                    }];
                }
            }

            // ë¹„êµ ê²°ê³¼ í‘œì‹œ (ì™„ì „ êµ¬í˜„ ë²„ì „)
            function displayComparisonResults(comparison) {
                console.log('ğŸ¨ ë¹„êµ ê²°ê³¼ UI ë Œë”ë§ ì‹œì‘...');
                
                // ê²°ê³¼ ì„¹ì…˜ ì°¾ê¸° ë˜ëŠ” ìƒì„±
                let comparisonSection = document.getElementById('comparisonResults');
                if (!comparisonSection) {
                    comparisonSection = document.createElement('div');
                    comparisonSection.id = 'comparisonResults';
                    comparisonSection.style.cssText = 'margin-top: 30px; padding: 20px; background: #1a1b2e; border-radius: 12px;';
                    
                    // ì—°ì£¼ ë…¹ìŒ ì„¹ì…˜ ë’¤ì— ì¶”ê°€
                    const recordingSection = document.querySelector('.recording-section');
                    if (recordingSection) {
                        recordingSection.parentNode.insertBefore(comparisonSection, recordingSection.nextSibling);
                    } else {
                        document.body.appendChild(comparisonSection);
                    }
                }

                // ìƒì„¸í•œ ë¹„êµ ê²°ê³¼ HTML ìƒì„±
                const html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                        <h2 style="color: white; text-align: center; margin: 0; font-size: 1.8em;">
                            ğŸ” ì›ë³¸ vs ì—°ì£¼ ë¹„êµ ë¶„ì„ ê²°ê³¼
                        </h2>
                        <p style="color: rgba(255,255,255,0.9); text-align: center; margin: 10px 0 0 0; font-size: 1.1em;">
                            AIê°€ ë¶„ì„í•œ ìƒì„¸í•œ ì—°ì£¼ í‰ê°€ ë° ê°œì„  ë°©í–¥
                        </p>
                    </div>

                    <!-- ì¢…í•© ì ìˆ˜ ì¹´ë“œ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #2c3e50; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: #3498db; font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.similarity}%
                            </div>
                            <div style="color: #ecf0f1; font-size: 1.1em; font-weight: 500;">ì „ì²´ ìœ ì‚¬ë„</div>
                        </div>
                        <div style="background: #27ae60; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.originalTempo} BPM
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">ì›ë³¸ í…œí¬</div>
                        </div>
                        <div style="background: #e74c3c; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.recordingTempo} BPM
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">ì—°ì£¼ í…œí¬</div>
                        </div>
                        <div style="background: #9b59b6; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.keyMatch ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">ì¡°ì„±</div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ ë¹„êµ ì„¹ì…˜ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- ì›ë³¸ ë¶„ì„ -->
                        <div style="background: #34495e; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #3498db; margin-top: 0; text-align: center;">
                                ğŸ¼ ì›ë³¸ íŒŒì¼ ë¶„ì„
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">íŒŒí˜• ê°•ë„:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.waveform.originalRMS.toFixed(3)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">í‰ê·  ìŒì •:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.pitch.originalPitch.toFixed(1)} Hz</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">ì¡°ì„±:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.overall.originalKey}</span>
                                </div>
                            </div>
                        </div>

                        <!-- ì—°ì£¼ ë¶„ì„ -->
                        <div style="background: #34495e; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #e74c3c; margin-top: 0; text-align: center;">
                                ğŸ¹ ì—°ì£¼ íŒŒì¼ ë¶„ì„
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">íŒŒí˜• ê°•ë„:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.waveform.recordingRMS.toFixed(3)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">í‰ê·  ìŒì •:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.pitch.recordingPitch.toFixed(1)} Hz</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">ì¡°ì„±:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.overall.recordingKey}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì°¨ì´ ë¶„ì„ í…Œì´ë¸” -->
                    <div style="background: #2c3e50; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #f39c12; margin-top: 0; text-align: center;">ğŸ“Š ìˆ˜ì¹˜ ì°¨ì´ ë¶„ì„</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #ecf0f1;">
                                <thead>
                                    <tr style="background: rgba(243, 156, 18, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #f39c12;">ë¶„ì„ í•­ëª©</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">ì›ë³¸</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">ì—°ì£¼</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">ì°¨ì´</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">ìœ ì‚¬ë„</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #34495e;">ğŸµ í…œí¬ (BPM)</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.overall.originalTempo}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.overall.recordingTempo}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.overall.tempoDiff > 10 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.overall.tempoDiff.toFixed(1)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.rhythm.accuracy > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.rhythm.accuracy.toFixed(1)}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #34495e;">ğŸ¼ ìŒì • (Hz)</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.pitch.originalPitch.toFixed(1)}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.pitch.recordingPitch.toFixed(1)}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.pitch.pitchDiff > 50 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.pitch.pitchDiff.toFixed(1)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.pitch.similarity > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.pitch.similarity}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px;">ğŸ”Š íŒŒí˜• ê°•ë„</td>
                                        <td style="padding: 10px; text-align: center;">${comparison.waveform.originalRMS.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center;">${comparison.waveform.recordingRMS.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; color: ${comparison.waveform.rmsDiff > 0.1 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.waveform.rmsDiff.toFixed(3)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; color: ${comparison.waveform.similarity > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.waveform.similarity}%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- AI í”¼ë“œë°± -->
                    <div style="background: #2c3e50; padding: 20px; border-radius: 12px;">
                        <h3 style="color: #9b59b6; margin-top: 0; text-align: center;">ğŸ¤– AI ë§ì¶¤í˜• í”¼ë“œë°±</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${comparison.feedback.map(feedback => {
                                const colors = {
                                    success: { bg: 'rgba(39, 174, 96, 0.2)', border: '#27ae60', icon: 'âœ…' },
                                    info: { bg: 'rgba(52, 152, 219, 0.2)', border: '#3498db', icon: 'ğŸ’¡' },
                                    warning: { bg: 'rgba(243, 156, 18, 0.2)', border: '#f39c12', icon: 'âš ï¸' },
                                    error: { bg: 'rgba(231, 76, 60, 0.2)', border: '#e74c3c', icon: 'âŒ' }
                                };
                                const style = colors[feedback.type] || colors.info;
                                
                                return `
                                    <div style="background: ${style.bg}; border-left: 4px solid ${style.border}; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-size: 1.2em; margin-right: 8px;">${style.icon}</span>
                                            <span style="background: ${style.border}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-right: 10px;">
                                                ${feedback.category}
                                            </span>
                                            <span style="color: #ecf0f1; font-weight: bold; font-size: 1.05em;">
                                                ${feedback.title}
                                            </span>
                                        </div>
                                        <div style="color: rgba(236, 240, 241, 0.9); margin-bottom: 10px; line-height: 1.4;">
                                            ${feedback.message.replace(/\n/g, '<br>')}
                                        </div>
                                        <div style="color: ${style.border}; font-weight: 500; font-style: italic;">
                                            ğŸ’¡ ê°œì„  ë°©í–¥: ${feedback.improvement}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- ë¶„ì„ ì™„ë£Œ ì‹œê°„ -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(149, 165, 166, 0.1); border-radius: 8px;">
                        <p style="color: #95a5a6; margin: 0; font-size: 0.9em;">
                            ğŸ•’ ë¶„ì„ ì™„ë£Œ: ${new Date().toLocaleString('ko-KR')} | 
                            âš¡ PianoAI Coachì˜ ì²¨ë‹¨ AI ë¶„ì„ ê¸°ìˆ ë¡œ ì œê³µë¨
                        </p>
                    </div>
                `;

                comparisonSection.innerHTML = html;
                comparisonSection.style.display = 'block';
                
                console.log('ğŸ‰ ë¹„êµ ê²°ê³¼ UI ë Œë”ë§ ì™„ë£Œ!');
            }

            // ë¹„êµ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ëª¨ë“  ë²„íŠ¼ì„ í™œì„±í™”)
            function updateComparisonButtons() {
                console.log('ğŸ”„ ë¹„êµ ë²„íŠ¼ë“¤ ì—…ë°ì´íŠ¸ ì¤‘...');
                
                // ëª¨ë“  ë¹„êµ ë²„íŠ¼ ì°¾ê¸°
                const comparisonButtons = document.querySelectorAll('button[onclick*="showComparisonResults"]');
                
                comparisonButtons.forEach((button, index) => {
                    if (window.originalAnalysis && window.recordingAnalysis) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                        button.style.background = '#4a90e2';
                        console.log(`âœ… ë¹„êµ ë²„íŠ¼ ${index + 1} í™œì„±í™”ë¨`);
                    } else {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                        button.style.background = '#666';
                        console.log(`âŒ ë¹„êµ ë²„íŠ¼ ${index + 1} ë¹„í™œì„±í™”ë¨ (ì›ë³¸: ${!!window.originalAnalysis}, ì—°ì£¼: ${!!window.recordingAnalysis})`);
                    }
                });
            }

            // ìœ ì‚¬ë„ ê³„ì‚° (0-100%)
            function calculateSimilarity(value1, value2, tolerance = 0) {
                if (value1 === 0 && value2 === 0) return 100;
                const maxValue = Math.max(value1, value2);
                if (maxValue === 0) return 100;
                
                const diff = Math.abs(value1 - value2);
                if (tolerance > 0 && diff <= tolerance) return 100;
                
                const similarity = Math.max(0, 100 - (diff / maxValue) * 100);
                return Math.round(similarity);
            }

            // AI í”¼ë“œë°± ìƒì„±
            function generateAIFeedback(comparison) {
                const feedback = [];
                
                // í…œí¬ í”¼ë“œë°±
                if (comparison.overall.tempoDiff > 10) {
                    if (comparison.overall.recordingTempo > comparison.overall.originalTempo) {
                        feedback.push({
                            type: 'rhythm',
                            level: 'warning',
                            message: `ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ${comparison.overall.tempoDiff.toFixed(1)} BPM ë¹ ë¦…ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ì²œì²œíˆ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    } else {
                        feedback.push({
                            type: 'rhythm',
                            level: 'warning',
                            message: `ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ${comparison.overall.tempoDiff.toFixed(1)} BPM ëŠë¦½ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ë¹ ë¥´ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    }
                } else if (comparison.overall.tempoDiff <= 5) {
                    feedback.push({
                        type: 'rhythm',
                        level: 'success',
                        message: 'í›Œë¥­í•´ìš”! í…œí¬ê°€ ì›ë³¸ê³¼ ê±°ì˜ ì¼ì¹˜í•©ë‹ˆë‹¤.'
                    });
                }

                // ìŒì • í”¼ë“œë°±
                if (comparison.pitch.pitchDiff > 50) {
                    if (comparison.pitch.recordingPitch > comparison.pitch.originalPitch) {
                        feedback.push({
                            type: 'pitch',
                            level: 'warning',
                            message: `ì—°ì£¼ì˜ ìŒì •ì´ ì›ë³¸ë³´ë‹¤ ${comparison.pitch.pitchDiff.toFixed(1)} Hz ë†’ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë” ë‚®ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    } else {
                        feedback.push({
                            type: 'pitch',
                            level: 'warning',
                            message: `ì—°ì£¼ì˜ ìŒì •ì´ ì›ë³¸ë³´ë‹¤ ${comparison.pitch.pitchDiff.toFixed(1)} Hz ë‚®ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë” ë†’ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                        });
                    }
                } else {
                    feedback.push({
                        type: 'pitch',
                        level: 'success',
                        message: 'ì¢‹ì•„ìš”! ìŒì •ì´ ì›ë³¸ê³¼ ì˜ ë§ìŠµë‹ˆë‹¤.'
                    });
                }

                // ë³¼ë¥¨ í”¼ë“œë°±
                if (comparison.waveform.rmsDiff > 0.1) {
                    if (comparison.waveform.recordingRMS > comparison.waveform.originalRMS) {
                        feedback.push({
                            type: 'waveform',
                            level: 'info',
                            message: 'ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ì¡°ê¸ˆ í¬ê²Œ ë“¤ë¦½ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ë¶€ë“œëŸ½ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.'
                        });
                    } else {
                        feedback.push({
                            type: 'waveform',
                            level: 'info',
                            message: 'ì—°ì£¼ê°€ ì›ë³¸ë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ ë“¤ë¦½ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ê°•í•˜ê²Œ ì—°ì£¼í•´ë³´ì„¸ìš”.'
                        });
                    }
                }

                // ì¡° (í‚¤) í”¼ë“œë°±
                if (!comparison.overall.keyMatch) {
                    feedback.push({
                        type: 'pitch',
                        level: 'error',
                        message: `ì—°ì£¼í•œ ì¡°ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ì›ë³¸: ${comparison.overall.originalKey}, ì—°ì£¼: ${comparison.overall.recordingKey}`
                    });
                }

                // ì „ì²´ í‰ê°€
                const overallScore = Math.round((comparison.waveform.similarity + comparison.pitch.similarity + comparison.rhythm.accuracy) / 3);
                if (overallScore >= 90) {
                    feedback.push({
                        type: 'overall',
                        level: 'success',
                        message: `ğŸ‰ í›Œë¥­í•œ ì—°ì£¼ì…ë‹ˆë‹¤! ì›ë³¸ê³¼ ${overallScore}% ì¼ì¹˜í•©ë‹ˆë‹¤.`
                    });
                } else if (overallScore >= 70) {
                    feedback.push({
                        type: 'overall',
                        level: 'info',
                        message: `ğŸ‘ ì¢‹ì€ ì—°ì£¼ì…ë‹ˆë‹¤! ì›ë³¸ê³¼ ${overallScore}% ì¼ì¹˜í•©ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ì™„ë²½í•´ì§ˆ ê²ƒ ê°™ì•„ìš”.`
                    });
                } else {
                    feedback.push({
                        type: 'overall',
                        level: 'warning',
                        message: `ğŸ’ª ì—°ìŠµì´ ë” í•„ìš”í•´ìš”. ì›ë³¸ê³¼ ${overallScore}% ì¼ì¹˜í•©ë‹ˆë‹¤. í…œí¬ì™€ ìŒì •ì„ ë” ì£¼ì˜í•´ì„œ ì—°ì£¼í•´ë³´ì„¸ìš”.`
                    });
                }

                return feedback;
            }

            // ë¹„êµ ê²°ê³¼ í™”ë©´ í‘œì‹œ
            function displayComparisonResults(comparison) {
                // ìƒˆë¡œìš´ ë¹„êµ ê²°ê³¼ ì˜ì—­ ìƒì„± ë˜ëŠ” ê¸°ì¡´ ì˜ì—­ ì—…ë°ì´íŠ¸
                let comparisonDiv = document.getElementById('comparisonResults');
                if (!comparisonDiv) {
                    comparisonDiv = document.createElement('div');
                    comparisonDiv.id = 'comparisonResults';
                    comparisonDiv.style.cssText = `
                        background: #16213e; 
                        border-radius: 12px; 
                        padding: 25px; 
                        margin: 20px 0; 
                        border: 2px solid #4a90e2;
                        max-width: 1000px;
                        margin-left: auto;
                        margin-right: auto;
                    `;
                    
                    // ì—°ì£¼ ì—…ë¡œë“œ ê²°ê³¼ ë‹¤ìŒì— ì‚½ì…
                    const recordingUploadResults = document.getElementById('recordingUploadResults');
                    if (recordingUploadResults && recordingUploadResults.parentNode) {
                        recordingUploadResults.parentNode.insertBefore(comparisonDiv, recordingUploadResults.nextSibling);
                    } else {
                        document.querySelector('.container').appendChild(comparisonDiv);
                    }
                }

                const html = `
                    <div class="comparison-analysis">
                        <h2 style="text-align:center;color:#4a90e2;margin-bottom:25px;">
                            <i class="fas fa-balance-scale"></i>
                            ì›ë³¸ vs ì—°ì£¼ ë¹„êµ ë¶„ì„
                        </h2>

                        <!-- ì „ì²´ ìš”ì•½ -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;margin-bottom:25px;">
                            <h3 style="color:#4ad991;margin-bottom:15px;">ğŸ“Š ì „ì²´ ë¶„ì„ ê²°ê³¼</h3>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#ffb347;margin-bottom:8px;">í…œí¬ ë¹„êµ</h4>
                                    <p style="color:#e0e6ed;">ì›ë³¸: ${comparison.overall.originalTempo} BPM</p>
                                    <p style="color:#e0e6ed;">ì—°ì£¼: ${comparison.overall.recordingTempo} BPM</p>
                                    <p style="color:${comparison.overall.tempoDiff <= 5 ? '#4ad991' : comparison.overall.tempoDiff <= 15 ? '#ffb347' : '#ff6b6b'};">
                                        ì°¨ì´: ${comparison.overall.tempoDiff.toFixed(1)} BPM
                                    </p>
                                </div>
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#7f8cff;margin-bottom:8px;">í‚¤ ë¹„êµ</h4>
                                    <p style="color:#e0e6ed;">ì›ë³¸: ${comparison.overall.originalKey}</p>
                                    <p style="color:#e0e6ed;">ì—°ì£¼: ${comparison.overall.recordingKey}</p>
                                    <p style="color:${comparison.overall.keyMatch ? '#4ad991' : '#ff6b6b'};">
                                        ${comparison.overall.keyMatch ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}
                                    </p>
                                </div>
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#4ad991;margin-bottom:8px;">ì „ì²´ ìœ ì‚¬ë„</h4>
                                    <p style="font-size:1.5em;font-weight:bold;color:${
                                        comparison.rhythm.accuracy >= 90 ? '#4ad991' : 
                                        comparison.rhythm.accuracy >= 70 ? '#ffb347' : '#ff6b6b'
                                    };">
                                        ${Math.round((comparison.waveform.similarity + comparison.pitch.similarity + comparison.rhythm.accuracy) / 3)}%
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- ìƒì„¸ ë¹„êµ ì‹œê°í™” -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;margin-bottom:25px;">
                            <h3 style="color:#4ad991;margin-bottom:20px;">ğŸ“ˆ ìƒì„¸ ë¹„êµ ì‹œê°í™”</h3>
                            
                            <!-- íŒŒí˜• ë¹„êµ -->
                            <div style="margin-bottom:25px;">
                                <h4 style="color:#4ad991;margin-bottom:10px;">
                                    <i class="fas fa-wave-square"></i>
                                    íŒŒí˜• ë¹„êµ (ìœ ì‚¬ë„: ${comparison.waveform.similarity}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#4ad991;margin-bottom:5px;">ì›ë³¸ íŒŒí˜•</p>
                                        <canvas id="comparisonOriginalWaveform" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #4ad991;"></canvas>
                                        <p style="font-size:0.9em;color:#4ad991;margin-top:5px;">RMS: ${comparison.waveform.originalRMS.toFixed(3)}</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#4ad991;margin-bottom:5px;">ì—°ì£¼ íŒŒí˜•</p>
                                        <canvas id="comparisonRecordingWaveform" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #4ad991;"></canvas>
                                        <p style="font-size:0.9em;color:#4ad991;margin-top:5px;">RMS: ${comparison.waveform.recordingRMS.toFixed(3)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ìŒì • ë¹„êµ -->
                            <div style="margin-bottom:25px;">
                                <h4 style="color:#ffb347;margin-bottom:10px;">
                                    <i class="fas fa-music"></i>
                                    ìŒì • ë¹„êµ (ìœ ì‚¬ë„: ${comparison.pitch.similarity}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#ffb347;margin-bottom:5px;">ì›ë³¸ ìŒì •</p>
                                        <canvas id="comparisonOriginalPitch" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #ffb347;"></canvas>
                                        <p style="font-size:0.9em;color:#ffb347;margin-top:5px;">í‰ê· : ${comparison.pitch.originalPitch.toFixed(1)} Hz</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#ffb347;margin-bottom:5px;">ì—°ì£¼ ìŒì •</p>
                                        <canvas id="comparisonRecordingPitch" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #ffb347;"></canvas>
                                        <p style="font-size:0.9em;color:#ffb347;margin-top:5px;">í‰ê· : ${comparison.pitch.recordingPitch.toFixed(1)} Hz</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ë°•ì ë¹„êµ -->
                            <div style="margin-bottom:20px;">
                                <h4 style="color:#7f8cff;margin-bottom:10px;">
                                    <i class="fas fa-drum"></i>
                                    ë°•ì ë¹„êµ (ì •í™•ë„: ${Math.round(comparison.rhythm.accuracy)}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#7f8cff;margin-bottom:5px;">ì›ë³¸ ë°•ì</p>
                                        <canvas id="comparisonOriginalRhythm" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #7f8cff;"></canvas>
                                        <p style="font-size:0.9em;color:#7f8cff;margin-top:5px;">${comparison.overall.originalTempo} BPM</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#7f8cff;margin-bottom:5px;">ì—°ì£¼ ë°•ì</p>
                                        <canvas id="comparisonRecordingRhythm" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #7f8cff;"></canvas>
                                        <p style="font-size:0.9em;color:#7f8cff;margin-top:5px;">${comparison.overall.recordingTempo} BPM</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI í”¼ë“œë°± -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;">
                            <h3 style="color:#4ad991;margin-bottom:15px;">ğŸ¤– AI í”¼ë“œë°±</h3>
                            <div class="feedback-list">
                                ${comparison.feedback.map(f => `
                                    <div style="
                                        background:${f.level === 'success' ? '#0d3d0d' : f.level === 'warning' ? '#3d2a0d' : f.level === 'error' ? '#3d0d0d' : '#0d1a3d'};
                                        border-left: 4px solid ${f.level === 'success' ? '#4ad991' : f.level === 'warning' ? '#ffb347' : f.level === 'error' ? '#ff6b6b' : '#7f8cff'};
                                        padding: 12px 15px;
                                        margin-bottom: 10px;
                                        border-radius: 6px;
                                    ">
                                        <span style="color:${f.level === 'success' ? '#4ad991' : f.level === 'warning' ? '#ffb347' : f.level === 'error' ? '#ff6b6b' : '#7f8cff'};font-weight:500;">
                                            ${f.type === 'rhythm' ? 'ğŸ¥' : f.type === 'pitch' ? 'ğŸµ' : f.type === 'waveform' ? 'ğŸ“Š' : 'ğŸ¯'} 
                                        </span>
                                        <span style="color:#e0e6ed;">${f.message}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="text-align:center;margin-top:20px;color:#666;font-size:12px;">
                            <p><small>ë¹„êµ ë¶„ì„ ì™„ë£Œ: ${new Date().toLocaleString()}</small></p>
                        </div>
                    </div>
                `;

                comparisonDiv.innerHTML = html;
                comparisonDiv.style.display = 'block';

                // ë¹„êµ ì‹œê°í™” ê·¸ë¦¬ê¸°
                setTimeout(() => {
                    drawWaveform('comparisonOriginalWaveform', window.originalAnalysis.waveformData);
                    drawWaveform('comparisonRecordingWaveform', window.recordingAnalysis.waveformData);
                    drawPitch('comparisonOriginalPitch', window.originalAnalysis.pitchData);
                    drawPitch('comparisonRecordingPitch', window.recordingAnalysis.pitchData);
                    drawRhythm('comparisonOriginalRhythm', window.originalAnalysis.rhythmData);
                    drawRhythm('comparisonRecordingRhythm', window.recordingAnalysis.rhythmData);
                }, 100);

                // ë¹„êµ ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
                comparisonDiv.scrollIntoView({ behavior: 'smooth' });
                
                console.log('âœ… ë¹„êµ ê²°ê³¼ UI í‘œì‹œ ì™„ë£Œ');
            }

            console.log('ğŸ¹ PianoAI Coach ì´ˆê¸°í™” ì™„ë£Œ!');
        });
    </script>
</body>
</html> 