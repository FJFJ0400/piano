<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎹 PianoAI Coach - AI 피아노 연습 도구</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-piano"></i>
                <h1>PianoAI Coach</h1>
            </div>
            <p class="subtitle">AI 기반 피아노 연주 분석 및 비교 도구</p>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 파일 업로드 섹션 -->
            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>음원 또는 동영상 파일 업로드</h3>
                        <p>MP3, WAV, MP4 등 다양한 형식을 지원합니다</p>
                        <button class="upload-btn" id="uploadBtn">
                            <i class="fas fa-folder-open"></i>
                            파일 선택
                        </button>
                        <input type="file" id="fileInput" accept="audio/*,video/*" hidden>
                    </div>
                </div>
            </section>

            <!-- 분석 결과 섹션 -->
            <section class="analysis-section" id="analysisSection" style="display: none;">
                <div class="analysis-header">
                    <h2><i class="fas fa-chart-line"></i> AI 분석 결과</h2>
                    <div class="file-info" id="fileInfo"></div>
                </div>
                <div class="analysis-stack" style="display:flex;flex-direction:column;gap:32px;align-items:stretch;">
                    <!-- 원본 분석 -->
                    <div class="analysis-card" style="box-shadow:0 2px 8px #0001;padding:24px 20px 20px 20px;background:#23243a;border-radius:16px;">
                        <h3 style="margin-bottom:16px;"><i class="fas fa-music"></i> 원본 분석</h3>
                        <div class="analysis-content" id="originalAnalysis">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>분석 중...</p>
                            </div>
                        </div>
                    </div>
                    <!-- 연주 녹음 -->
                    <div class="analysis-card" style="box-shadow:0 2px 8px #0001;padding:24px 20px 20px 20px;background:#23243a;border-radius:16px;">
                        <h3 style="margin-bottom:16px;"><i class="fas fa-microphone"></i> 연주 녹음</h3>
                        <div class="recording-controls" style="margin-bottom:12px;display:flex;gap:10px;align-items:center;">
                            <button class="record-btn" id="recordBtn">
                                <i class="fas fa-microphone"></i>
                                녹음 시작
                            </button>
                            <button class="stop-btn" id="stopBtn" disabled>
                                <i class="fas fa-stop"></i>
                                녹음 중지
                            </button>
                        </div>
                        
                        <!-- 연주 녹음 파일 업로드 섹션 (화살표 위치) -->
                        <div class="recording-upload-section" style="margin-top:16px;margin-bottom:16px;padding:16px;background:#1a1b2e;border-radius:12px;border:2px dashed #4a90e2;">
                            <div class="upload-header" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                                <i class="fas fa-upload" style="color:#4a90e2;"></i>
                                <span style="font-weight:500;color:#e0e6ed;">연주 녹음 업로드</span>
                            </div>
                            <div class="upload-content" style="text-align:center;">
                                <p style="margin:8px 0;color:#9ca3af;font-size:14px;">피아노 연주 파일을 선택하면 즉시 분석이 시작됩니다</p>
                                <button class="upload-recording-btn" id="uploadRecordingFileBtn" style="background:#4a90e2;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s;">
                                    <i class="fas fa-folder-open"></i>
                                    녹음 파일 선택
                                </button>
                                <input type="file" id="recordingFileInput" accept="audio/*" hidden>
                                <div style="margin-top:8px;font-size:12px;color:#6b7280;">지원 형식: MP3, WAV, M4A, OGG</div>
                            </div>
                        </div>
                        
                        <!-- 업로드 진행 상황 표시 -->
                        <div id="recordingUploadProgress" style="display:none;margin-bottom:12px;">
                            <div class="progress-info">
                                <p>진행 상황이 여기에 표시됩니다...</p>
                            </div>
                        </div>
                        
                        <!-- 업로드 에러 표시 -->
                        <div id="recordingUploadError" style="display:none;margin-bottom:12px;" class="error-message">
                            <p>에러 메시지가 여기에 표시됩니다...</p>
                        </div>
                        
                        <div class="recording-status" id="recordingStatus"></div>
                        <div style="margin-bottom:10px;"></div>
                        <div class="analysis-content" id="recordingAnalysis" style="display: none;">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>분석 중...</p>
                            </div>
                        </div>
                        
                        <!-- 업로드된 파일 분석 결과 표시 -->
                        <div id="recordingUploadResults" style="display:none;">
                            <!-- 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
                <!-- 비교 결과 -->
                <div class="comparison-section" id="comparisonSection" style="display: none;">
                    <h3><i class="fas fa-balance-scale"></i> AI 비교 분석</h3>
                    <div class="comparison-content" id="comparisonContent">
                        <div class="score-card">
                            <div class="score-circle">
                                <span class="score-number" id="scoreNumber">0</span>
                                <span class="score-label">점수</span>
                            </div>
                            <div class="score-details">
                                <div class="score-item">
                                    <span class="score-label">음정 정확도</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="pitchScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="pitchValue">0%</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">리듬 정확도</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="rhythmScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="rhythmValue">0%</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">음색 유사도</span>
                                    <div class="score-bar">
                                        <div class="score-fill" id="timbreScore" style="width: 0%"></div>
                                    </div>
                                    <span class="score-value" id="timbreValue">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="feedback-card">
                            <h4><i class="fas fa-comments"></i> AI 피드백</h4>
                            <div class="feedback-content" id="feedbackContent">
                                <p>연주를 녹음하면 AI가 자세한 피드백을 제공합니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 기존 연주 녹음 업로드 섹션 제거됨 - 새 위치로 이동 -->
        </main>

        <!-- 푸터 -->
        <footer class="footer">
            <p>&copy; 2024 PianoAI Coach. AI 기반 피아노 연습 도구</p>
        </footer>
    </div>

    <!-- 스크립트 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/audio-analyzer.js"></script>
    <script src="js/ai-comparison.js"></script>
    <script>
        // 전역 함수 정의 (먼저 정의) - 완전 수정됨
        // 파형/음정/박자 시각화 함수들
        function drawWaveform(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 배경 설정
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // 실제 파형 데이터 그리기
                ctx.strokeStyle = '#4ad991';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const amplitude = data[i].amplitude || 0;
                    const y = canvas.height / 2 + (amplitude - 50) * (canvas.height / 100);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            } else {
                // 기본 파형 그리기
                ctx.strokeStyle = '#4ad991';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.sin(x/10) * 20 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }
        
        function drawPitch(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 배경 설정
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // 실제 피치 데이터 그리기
                ctx.strokeStyle = '#ffb347';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                // 주파수 범위 정규화 (50Hz ~ 1000Hz)
                const minFreq = 50;
                const maxFreq = 1000;
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const frequency = data[i].frequency || 200;
                    const normalizedFreq = (frequency - minFreq) / (maxFreq - minFreq);
                    const y = canvas.height - (normalizedFreq * canvas.height);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            } else {
                // 기본 피치 그리기
                ctx.strokeStyle = '#ffb347';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.cos(x/15) * 15 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }
        
        function drawRhythm(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 배경 설정
            ctx.fillStyle = '#0e0f1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (data && data.length > 0) {
                // 실제 리듬 데이터 그리기 (박자 강도)
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * canvas.width;
                    const energy = data[i].energy || 0;
                    const y = canvas.height - (energy * canvas.height);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // 박자 표시 (세로선)
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 0.5;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].isBeat) {
                        const x = (i / data.length) * canvas.width;
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, canvas.height);
                        ctx.stroke();
                    }
                }
            } else {
                // 기본 리듬 그리기
                ctx.strokeStyle = '#7f8cff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height/2 + (Math.sin(x/5) * 10 * Math.random());
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }

        // 전역 PianoAI 비교 분석 시스템 (완전 구현)
        window.PianoAI = {
            originalData: null,
            recordingData: null,
            
            // 원본 데이터 저장
            setOriginal(data) {
                this.originalData = data;
                console.log('💾 PianoAI - 원본 데이터 저장:', data.fileName || 'unknown');
                this.checkComparison();
            },
            
            // 연주 데이터 저장
            setRecording(data) {
                this.recordingData = data;
                console.log('💾 PianoAI - 연주 데이터 저장:', data.fileName || 'unknown');
                this.checkComparison();
            },
            
            // 비교 가능 여부 확인 및 버튼 활성화
            checkComparison() {
                const canCompare = this.originalData && this.recordingData;
                console.log('🔍 PianoAI - 비교 가능 여부:', canCompare);
                
                if (canCompare) {
                    this.enableComparisonButtons();
                    this.showComparisonSection();
                }
            },
            
            // 비교 버튼들 활성화
            enableComparisonButtons() {
                console.log('🔧 PianoAI - 비교 버튼들 활성화 중...');
                
                // 기존 버튼들 활성화
                const buttons = document.querySelectorAll('button[onclick*="showComparisonResults"], button[onclick*="compareAnalysis"]');
                buttons.forEach((btn, index) => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.background = '#4a90e2';
                    console.log(`✅ 기존 비교 버튼 ${index + 1} 활성화됨`);
                });
                
                // 새로운 메인 비교 버튼 생성
                this.createMainComparisonButton();
            },
            
            // 비교 섹션 표시
            showComparisonSection() {
                const section = document.getElementById('comparisonSection');
                if (section) {
                    section.style.display = 'block';
                    section.style.opacity = '1';
                }
            },
            
            // 메인 비교 버튼 생성 (핵심 기능)
            createMainComparisonButton() {
                // 기존 버튼이 있는지 확인
                if (document.getElementById('mainComparisonBtn')) {
                    console.log('✅ 메인 비교 버튼 이미 존재함');
                    return;
                }
                
                const recordingUploadResults = document.getElementById('recordingUploadResults');
                if (recordingUploadResults && recordingUploadResults.style.display !== 'none') {
                    const buttonHtml = `
                        <div id="mainComparisonSection" style="text-align: center; margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                            <div style="margin-bottom: 15px;">
                                <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.3em;">🤖 AI 비교 분석</h3>
                                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 0.95em;">
                                    원본과 연주를 AI가 상세 분석하여 맞춤형 피드백을 제공합니다
                                </p>
                            </div>
                            <button id="mainComparisonBtn" onclick="window.PianoAI.performComparison()" 
                                    style="background: #ffffff; color: #667eea; border: none; padding: 18px 35px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1.15em; box-shadow: 0 6px 20px rgba(0,0,0,0.15); transition: all 0.3s ease; transform: scale(1);">
                                <i class="fas fa-chart-line" style="margin-right: 8px;"></i>상세 비교 분석 시작
                            </button>
                            <div style="margin-top: 12px; color: rgba(255,255,255,0.8); font-size: 0.85em;">
                                ✨ 템포, 음정, 파형을 종합 분석하여 개선점을 제시합니다
                            </div>
                        </div>
                    `;
                    
                    recordingUploadResults.insertAdjacentHTML('beforeend', buttonHtml);
                    
                    // 버튼 호버 효과 추가
                    const btn = document.getElementById('mainComparisonBtn');
                    btn.addEventListener('mouseenter', () => {
                        btn.style.transform = 'scale(1.05)';
                        btn.style.background = '#f0f0f0';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'scale(1)';
                        btn.style.background = '#ffffff';
                    });
                    
                    console.log('🎯 메인 비교 버튼 생성 완료');
                }
            },
            
            // 비교 분석 수행 (핵심 함수)
            async performComparison() {
                console.log('🚀 PianoAI - 비교 분석 시작!');
                
                if (!this.originalData || !this.recordingData) {
                    const status = `원본: ${this.originalData ? '✅' : '❌'} / 연주: ${this.recordingData ? '✅' : '❌'}`;
                    alert(`⚠️ 원본 파일과 연주 파일이 모두 필요합니다!\n\n현재 상태: ${status}`);
                    return;
                }
                
                try {
                    // 로딩 표시
                    this.showLoadingAnalysis();
                    
                    // 비교 분석 수행
                    const comparison = await this.detailedComparison();
                    
                    // 결과 표시
                    this.displayComparisonResults(comparison);
                    
                    // 결과로 스크롤
                    setTimeout(() => {
                        const resultsElement = document.getElementById('pianoAIComparisonResults') || 
                                             document.getElementById('comparisonResults');
                        if (resultsElement) {
                            resultsElement.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('❌ PianoAI 비교 분석 오류:', error);
                    alert('비교 분석 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    // 로딩 숨기기
                    this.hideLoadingAnalysis();
                }
            },
            
            // 로딩 표시
            showLoadingAnalysis() {
                let loadingDiv = document.getElementById('pianoAILoading');
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'pianoAILoading';
                    loadingDiv.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.95); color: white; padding: 40px; border-radius: 20px;
                        text-align: center; z-index: 10000; box-shadow: 0 15px 40px rgba(0,0,0,0.7);
                        min-width: 320px;
                    `;
                    document.body.appendChild(loadingDiv);
                }
                
                loadingDiv.innerHTML = `
                    <div style="font-size: 1.4em; margin-bottom: 20px;">🤖 AI 분석 중...</div>
                    <div style="color: #4a90e2; margin-bottom: 20px; line-height: 1.4;">
                        원본과 연주를 비교하여<br>
                        맞춤형 피드백을 생성하고 있습니다
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                        잠시만 기다려주세요...
                    </div>
                `;
                loadingDiv.style.display = 'block';
                
                // 추가 스타일 (animation)
                if (!document.getElementById('pianoAILoadingStyle')) {
                    const style = document.createElement('style');
                    style.id = 'pianoAILoadingStyle';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },
            
            // 로딩 숨기기
            hideLoadingAnalysis() {
                const loadingDiv = document.getElementById('pianoAILoading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            },
            
            // 상세 비교 분석 (핵심 엔진)
            async detailedComparison() {
                console.log('🔍 상세 비교 분석 시작...');
                
                const original = this.originalData;
                const recording = this.recordingData;
                
                // 1. 템포 비교
                const tempoDiff = Math.abs((original.tempo || 0) - (recording.tempo || 0));
                const tempoSimilarity = Math.max(0, 100 - (tempoDiff * 2)); // 2 BPM당 1점 감점
                
                // 2. 음정 비교 (평균 주파수)
                const originalPitch = this.calculateAveragePitch(original.pitchData);
                const recordingPitch = this.calculateAveragePitch(recording.pitchData);
                const pitchDiff = Math.abs(originalPitch - recordingPitch);
                const pitchSimilarity = Math.max(0, 100 - (pitchDiff / 2)); // 2Hz당 1점 감점
                
                // 3. 파형 비교 (RMS)
                const originalRMS = this.calculateAverageRMS(original.volumeData);
                const recordingRMS = this.calculateAverageRMS(recording.volumeData);
                const rmsDiff = Math.abs(originalRMS - recordingRMS);
                const waveformSimilarity = Math.max(0, 100 - (rmsDiff * 100)); // 0.01 RMS당 1점 감점
                
                // 4. 키 일치 여부
                const keyMatch = (original.key === recording.key);
                
                // 5. 전체 유사도 계산
                const totalSimilarity = (tempoSimilarity + pitchSimilarity + waveformSimilarity) / 3;
                
                // 6. AI 피드백 생성
                const feedback = this.generateAIFeedback({
                    tempoDiff,
                    pitchDiff,
                    rmsDiff,
                    keyMatch,
                    originalTempo: original.tempo,
                    recordingTempo: recording.tempo,
                    originalKey: original.key,
                    recordingKey: recording.key,
                    totalSimilarity
                });
                
                return {
                    tempo: {
                        original: original.tempo || 0,
                        recording: recording.tempo || 0,
                        difference: tempoDiff,
                        similarity: tempoSimilarity
                    },
                    pitch: {
                        original: originalPitch,
                        recording: recordingPitch,
                        difference: pitchDiff,
                        similarity: pitchSimilarity
                    },
                    waveform: {
                        original: originalRMS,
                        recording: recordingRMS,
                        difference: rmsDiff,
                        similarity: waveformSimilarity
                    },
                    key: {
                        original: original.key || 'Unknown',
                        recording: recording.key || 'Unknown',
                        match: keyMatch
                    },
                    overall: {
                        similarity: totalSimilarity,
                        grade: this.calculateGrade(totalSimilarity)
                    },
                    feedback: feedback
                };
            },
            
            // 평균 RMS 계산
            calculateAverageRMS(volumeData) {
                if (!volumeData || volumeData.length === 0) return 0;
                const total = volumeData.reduce((sum, item) => sum + (item.volume || item.rms || 0), 0);
                return total / volumeData.length;
            },
            
            // 평균 피치 계산
            calculateAveragePitch(pitchData) {
                if (!pitchData || pitchData.length === 0) return 0;
                const validPitches = pitchData.filter(p => p.frequency && p.frequency > 0);
                if (validPitches.length === 0) return 0;
                const total = validPitches.reduce((sum, p) => sum + p.frequency, 0);
                return total / validPitches.length;
            },
            
            // 등급 계산
            calculateGrade(similarity) {
                if (similarity >= 95) return 'A+';
                if (similarity >= 90) return 'A';
                if (similarity >= 85) return 'B+';
                if (similarity >= 80) return 'B';
                if (similarity >= 75) return 'C+';
                if (similarity >= 70) return 'C';
                if (similarity >= 60) return 'D';
                return 'F';
            },
            
            // AI 피드백 생성
            generateAIFeedback({tempoDiff, pitchDiff, rmsDiff, keyMatch, originalTempo, recordingTempo, originalKey, recordingKey, totalSimilarity}) {
                const feedbacks = [];
                
                // 템포 피드백
                if (tempoDiff > 10) {
                    if (recordingTempo > originalTempo) {
                        feedbacks.push({
                            type: 'warning',
                            title: '템포가 너무 빠릅니다',
                            message: `원본보다 ${tempoDiff.toFixed(1)} BPM 빠릅니다. 좀 더 차분하게 연주해보세요.`
                        });
                    } else {
                        feedbacks.push({
                            type: 'warning',
                            title: '템포가 너무 느립니다',
                            message: `원본보다 ${tempoDiff.toFixed(1)} BPM 느립니다. 좀 더 빠르게 연주해보세요.`
                        });
                    }
                } else if (tempoDiff <= 5) {
                    feedbacks.push({
                        type: 'success',
                        title: '훌륭한 템포 유지',
                        message: '원본과 거의 동일한 템포로 연주하셨습니다!'
                    });
                }
                
                // 음정 피드백
                if (pitchDiff > 50) {
                    feedbacks.push({
                        type: 'warning',
                        title: '음정 정확도 개선 필요',
                        message: `평균 ${pitchDiff.toFixed(1)}Hz 차이가 있습니다. 정확한 음정을 연습해보세요.`
                    });
                } else if (pitchDiff <= 20) {
                    feedbacks.push({
                        type: 'success',
                        title: '정확한 음정',
                        message: '매우 정확한 음정으로 연주하셨습니다!'
                    });
                }
                
                // 볼륨/파형 피드백
                if (rmsDiff > 0.1) {
                    feedbacks.push({
                        type: 'info',
                        title: '연주 강도 조절',
                        message: '원본과 다른 강도로 연주하셨습니다. 표현력을 위한 의도적 변화라면 좋습니다!'
                    });
                }
                
                // 키 피드백
                if (!keyMatch) {
                    feedbacks.push({
                        type: 'error',
                        title: '조성이 다릅니다',
                        message: `원본: ${originalKey}, 연주: ${recordingKey}. 같은 조성으로 연주해보세요.`
                    });
                } else {
                    feedbacks.push({
                        type: 'success',
                        title: '정확한 조성',
                        message: '원본과 동일한 조성으로 연주하셨습니다!'
                    });
                }
                
                // 전체 평가
                let overallFeedback = '';
                if (totalSimilarity >= 90) {
                    overallFeedback = '🎉 탁월한 연주입니다! 원본을 매우 잘 재현하셨습니다.';
                } else if (totalSimilarity >= 80) {
                    overallFeedback = '👍 좋은 연주입니다! 몇 가지만 개선하면 완벽해질 것 같습니다.';
                } else if (totalSimilarity >= 70) {
                    overallFeedback = '💪 괜찮은 연주입니다! 조금 더 연습하면 실력이 크게 향상될 것입니다.';
                } else {
                    overallFeedback = '📚 연습이 더 필요합니다. 기초부터 차근차근 다시 시작해보세요.';
                }
                
                return {
                    overall: overallFeedback,
                    details: feedbacks
                };
            },
            
            // 비교 결과 표시 (완전한 UI)
            displayComparisonResults(comparison) {
                console.log('🎨 비교 결과 표시 시작...', comparison);
                
                // 결과 표시 영역 생성 또는 업데이트
                let resultsDiv = document.getElementById('pianoAIComparisonResults');
                if (!resultsDiv) {
                    resultsDiv = document.createElement('div');
                    resultsDiv.id = 'pianoAIComparisonResults';
                    resultsDiv.style.cssText = `
                        margin: 30px auto; max-width: 900px; padding: 0 15px;
                    `;
                    
                    // 적절한 위치에 삽입
                    const recordingResults = document.getElementById('recordingUploadResults');
                    if (recordingResults && recordingResults.parentNode) {
                        recordingResults.parentNode.insertBefore(resultsDiv, recordingResults.nextSibling);
                    } else {
                        document.body.appendChild(resultsDiv);
                    }
                }
                
                // 결과 HTML 생성
                resultsDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <h2 style="color: white; text-align: center; margin: 0 0 25px 0; font-size: 1.8em;">
                            🤖 AI 비교 분석 결과
                        </h2>
                        
                        <!-- 종합 점수 카드 -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; margin-bottom: 25px; text-align: center;">
                            <div style="font-size: 3.5em; font-weight: bold; color: ${this.getScoreColor(comparison.overall.similarity)}; margin-bottom: 10px;">
                                ${comparison.overall.similarity.toFixed(1)}%
                            </div>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${this.getScoreColor(comparison.overall.similarity)}; margin-bottom: 8px;">
                                ${comparison.overall.grade} 등급
                            </div>
                            <div style="color: #666; font-size: 1.1em;">
                                전체 유사도
                            </div>
                        </div>
                        
                        <!-- 상세 비교 영역 -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            
                            <!-- 템포 비교 -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #667eea; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-tachometer-alt"></i> 템포 분석
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">원본:</span> 
                                    <span style="font-weight: bold;">${comparison.tempo.original} BPM</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">연주:</span> 
                                    <span style="font-weight: bold;">${comparison.tempo.recording} BPM</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">차이:</span> 
                                    <span style="font-weight: bold; color: ${comparison.tempo.difference > 10 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.tempo.difference.toFixed(1)} BPM
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.tempo.similarity)}; height: 100%; width: ${comparison.tempo.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.tempo.similarity)};">
                                    ${comparison.tempo.similarity.toFixed(1)}% 일치
                                </div>
                            </div>
                            
                            <!-- 음정 비교 -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #ffb347; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-music"></i> 음정 분석
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">원본:</span> 
                                    <span style="font-weight: bold;">${comparison.pitch.original.toFixed(1)} Hz</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">연주:</span> 
                                    <span style="font-weight: bold;">${comparison.pitch.recording.toFixed(1)} Hz</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">차이:</span> 
                                    <span style="font-weight: bold; color: ${comparison.pitch.difference > 50 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.pitch.difference.toFixed(1)} Hz
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.pitch.similarity)}; height: 100%; width: ${comparison.pitch.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.pitch.similarity)};">
                                    ${comparison.pitch.similarity.toFixed(1)}% 일치
                                </div>
                            </div>
                            
                            <!-- 파형 비교 -->
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #4ad991; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-wave-square"></i> 파형 분석
                                </h4>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">원본 RMS:</span> 
                                    <span style="font-weight: bold;">${comparison.waveform.original.toFixed(3)}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <span style="color: #666;">연주 RMS:</span> 
                                    <span style="font-weight: bold;">${comparison.waveform.recording.toFixed(3)}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <span style="color: #666;">차이:</span> 
                                    <span style="font-weight: bold; color: ${comparison.waveform.difference > 0.1 ? '#e74c3c' : '#27ae60'};">
                                        ${comparison.waveform.difference.toFixed(3)}
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; border-radius: 8px; height: 8px; margin-bottom: 8px;">
                                    <div style="background: ${this.getScoreColor(comparison.waveform.similarity)}; height: 100%; width: ${comparison.waveform.similarity}%; border-radius: 8px; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="text-align: center; font-weight: bold; color: ${this.getScoreColor(comparison.waveform.similarity)};">
                                    ${comparison.waveform.similarity.toFixed(1)}% 일치
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI 피드백 섹션 -->
                        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px;">
                            <h3 style="margin: 0 0 20px 0; color: #667eea; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-robot"></i> AI 피드백
                            </h3>
                            
                            <!-- 전체 평가 -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold;">
                                    ${comparison.feedback.overall}
                                </div>
                            </div>
                            
                            <!-- 상세 피드백 -->
                            <div style="display: grid; gap: 15px;">
                                ${comparison.feedback.details.map(feedback => `
                                    <div style="padding: 15px; border-radius: 8px; border-left: 4px solid ${this.getFeedbackColor(feedback.type)}; background: ${this.getFeedbackBackground(feedback.type)};">
                                        <div style="font-weight: bold; color: ${this.getFeedbackColor(feedback.type)}; margin-bottom: 5px;">
                                            ${this.getFeedbackIcon(feedback.type)} ${feedback.title}
                                        </div>
                                        <div style="color: #555; line-height: 1.4;">
                                            ${feedback.message}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('✅ 비교 결과 표시 완료');
            },
            
            // 점수 색상 결정
            getScoreColor(score) {
                if (score >= 90) return '#27ae60';
                if (score >= 80) return '#f39c12';
                if (score >= 70) return '#e67e22';
                return '#e74c3c';
            },
            
            // 피드백 타입별 색상
            getFeedbackColor(type) {
                const colors = {
                    success: '#27ae60',
                    info: '#3498db',
                    warning: '#f39c12',
                    error: '#e74c3c'
                };
                return colors[type] || '#666';
            },
            
            // 피드백 타입별 배경색
            getFeedbackBackground(type) {
                const backgrounds = {
                    success: '#d5ead5',
                    info: '#d6eaf8',
                    warning: '#fef5e7',
                    error: '#fadbd8'
                };
                return backgrounds[type] || '#f8f9fa';
            },
            
            // 피드백 타입별 아이콘
            getFeedbackIcon(type) {
                const icons = {
                    success: '✅',
                    info: 'ℹ️',
                    warning: '⚠️',
                    error: '❌'
                };
                return icons[type] || '📝';
            }
        };

        // 메인 애플리케이션 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎹 PianoAI Coach 초기화 중...');
            
            // 전역 변수
            let audioAnalyzer = null;
            let aiComparison = null;
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];

            // DOM 요소들
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const analysisSection = document.getElementById('analysisSection');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const recordingStatus = document.getElementById('recordingStatus');

            // 새로운 연주 녹음 파일 업로드 요소들
            const uploadRecordingFileBtn = document.getElementById('uploadRecordingFileBtn');
            const recordingFileInputNew = document.getElementById('recordingFileInput');
            const recordingUploadProgress = document.getElementById('recordingUploadProgress');
            const recordingUploadError = document.getElementById('recordingUploadError');
            const recordingUploadResults = document.getElementById('recordingUploadResults');

            // 파일 업로드 이벤트
            uploadBtn.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // 연주 녹음 파일 업로드 이벤트 (새 위치)
            uploadRecordingFileBtn.addEventListener('click', () => {
                recordingFileInputNew.click();
            });

            // 파일 선택 즉시 자동 업로드 실행
            recordingFileInputNew.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('🎵 파일 선택됨:', file.name, '- 즉시 업로드 시작');
                    await handleRecordingFileUploadAuto(file);
                }
            });

            // 새로운 자동 업로드 함수 (완전 강화)
            async function handleRecordingFileUploadAuto(file) {
                console.log('🎵 연주 파일 자동 업로드 시작:', file.name, file.size + ' bytes');

                // UI 요소들
                const statusDiv = recordingUploadResults;
                
                try {
                    // 로딩 상태 표시
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;background:#1a1b2e;border-radius:12px;">
                            <div style="color:#4ad991;font-size:1.2em;margin-bottom:10px;">
                                <i class="fas fa-spinner fa-spin"></i> 파일 분석 중...
                            </div>
                            <div style="color:#aaa;font-size:0.9em;">
                                파일: ${file.name}<br>
                                크기: ${(file.size / (1024*1024)).toFixed(2)}MB
                            </div>
                        </div>
                    `;

                    // 파일 크기 검증
                    if (file.size > 200 * 1024 * 1024) {
                        throw new Error('파일이 너무 큽니다 (200MB 이하만 지원). 더 작은 파일을 사용해주세요.');
                    }

                    if (file.size === 0) {
                        throw new Error('파일이 비어있습니다. 다른 파일을 선택해주세요.');
                    }

                    // AudioAnalyzer 초기화 (사용자 상호작용 시점)
                    if (!window.audioAnalyzer) {
                        console.log('🔧 AudioAnalyzer 생성 중...');
                        window.audioAnalyzer = new AudioAnalyzer();
                        await window.audioAnalyzer.initialize();
                        console.log('✅ AudioAnalyzer 초기화 완료');
                    }

                    // AudioContext 상태 확인 및 복구
                    if (window.audioAnalyzer.audioContext.state === 'suspended') {
                        console.log('🔄 AudioContext suspended → resume 시도');
                        await window.audioAnalyzer.audioContext.resume();
                        console.log('✅ AudioContext resumed:', window.audioAnalyzer.audioContext.state);
                    }

                    // 분석 시작
                    const analysisStartTime = Date.now();
                    
                    statusDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;background:#1a1b2e;border-radius:12px;">
                            <div style="color:#ffb347;font-size:1.2em;margin-bottom:10px;">
                                <i class="fas fa-cog fa-spin"></i> 고급 분석 진행 중...
                            </div>
                            <div style="color:#aaa;font-size:0.9em;">
                                음정, 박자, 파형 분석 중...<br>
                                ${file.name}
                            </div>
                        </div>
                    `;

                    // 파일 분석 실행
                    const analysisResult = await window.audioAnalyzer.analyzeFile(file);
                    
                    const analysisEndTime = Date.now();
                    const analysisDuration = ((analysisEndTime - analysisStartTime) / 1000).toFixed(1);
                    
                    console.log('✅ 고속 분석 완료! 소요시간:', analysisDuration + '초');

                    // 분석 결과 검증
                    if (!analysisResult) {
                        throw new Error('분석 결과가 없습니다. 파일이 손상되었을 수 있습니다.');
                    }

                    // 파일 이름 추가
                    analysisResult.fileName = file.name;
                    analysisResult.analyzedAt = Date.now();

                    // 전역 변수에 결과 저장 (강력한 시스템)
                    window.recordingAnalysis = analysisResult;
                    
                    // 새로운 PianoAI 시스템에도 저장
                    if (window.PianoAI) {
                        window.PianoAI.setRecording(analysisResult);
                    }
                    
                    console.log('💾 연주 분석 결과 저장 완료 (이중 저장)');

                    // 결과 표시
                    await displayRecordingUploadResults(analysisResult, analysisDuration);
                    
                    // 비교 버튼 업데이트
                    setTimeout(() => {
                        updateComparisonButtons();
                    }, 200);
                    
                    console.log('🎉 연주 파일 분석 및 표시 완료!');

                } catch (error) {
                    console.error('❌ 연주 파일 분석 실패:', error);
                    
                    // 에러 UI 표시
                    statusDiv.innerHTML = `
                        <div style="background:#2c1810;border:1px solid #d32f2f;border-radius:12px;padding:20px;margin:15px 0;">
                            <h3 style="color:#ff6b6b;margin-top:0;">❌ 분석 실패</h3>
                            <p style="color:#ffcc99;"><strong>오류:</strong> ${error.message}</p>
                            <div style="color:#ccc;font-size:0.9em;margin-top:15px;">
                                <h4>해결 방법:</h4>
                                <ul>
                                    <li>WAV, MP3, OGG 파일 형식을 사용해보세요</li>
                                    <li>파일 크기를 50MB 이하로 줄여보세요</li>
                                    <li>다른 오디오 파일로 시도해보세요</li>
                                    <li>브라우저를 새로고침하고 다시 시도해보세요</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }

            // 녹음 이벤트
            recordBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);

            // 파일 업로드 처리
            function handleFileUpload(file) {
                try {
                    const fileInfo = document.getElementById('fileInfo');
                    const analysisSection = document.getElementById('analysisSection');
                    const originalAnalysis = document.getElementById('originalAnalysis');
                    
                    const reader = new FileReader();
                    reader.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentLoaded = Math.round((event.loaded / event.total) * 100);
                            fileInfo.innerHTML = `<div class="file-details info">업로드 중... ${percentLoaded}%</div>`;
                        } else {
                            fileInfo.innerHTML = `<div class="file-details info">업로드 중...</div>`;
                        }
                    };
                    reader.onloadstart = () => {
                        fileInfo.innerHTML = `<div class="file-details info">업로드 시작...</div>`;
                    };
                    reader.onerror = (error) => {
                        fileInfo.innerHTML = `<div class="file-details error">업로드 실패: ${error.message}</div>`;
                    };
                    reader.onload = async (event) => {
                        fileInfo.innerHTML = `<div class="file-details success">업로드 완료! 분석 중...</div>`;
                        analysisSection.style.display = 'block';
                        originalAnalysis.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>분석 중...</p></div>`;
                        
                        // Chrome Web Audio 자동재생 정책 대응: 반드시 여기서 AudioAnalyzer 생성
                        audioAnalyzer = new AudioAnalyzer();
                        await audioAnalyzer.initialize();
                        
                        // AudioContext가 suspended면 resume
                        if (audioAnalyzer.audioContext && audioAnalyzer.audioContext.state === 'suspended') {
                            await audioAnalyzer.audioContext.resume();
                        }
                        
                        try {
                            const arrayBuffer = event.target.result;
                            const fileUrl = URL.createObjectURL(new Blob([arrayBuffer], {type: file.type}));
                            const analysis = await audioAnalyzer.analyzeFile(new File([arrayBuffer], file.name, {type: file.type}));
                            aiComparison = new AIComparison();
                            aiComparison.setOriginalAnalysis(analysis);
                            fileInfo.innerHTML = `<div class="file-details success">업로드 및 분석 완료! <span class='file-name'>${file.name}</span></div>`;
                            displayOriginalAnalysis(analysis, fileUrl);
                        } catch (error) {
                            fileInfo.innerHTML = `<div class="file-details error">분석 실패: ${error.message}</div>`;
                            showError('분석 실패: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    fileInfo.innerHTML = `<div class="file-details error">파일 업로드 중 오류: ${error.message}</div>`;
                    showError('파일 업로드 중 오류가 발생했습니다.');
                }
            }

            // 원본 분석 결과 표시
            function displayOriginalAnalysis(analysis, audioUrl) {
                // 전역 변수에 원본 분석 결과 저장 (강화된 버전)
                window.originalAnalysis = analysis;
                
                // PianoAI 시스템에도 저장
                if (window.PianoAI) {
                    window.PianoAI.setOriginal(analysis);
                }
                
                console.log('💾 원본 분석 데이터 저장 완료 (이중 저장):', analysis);
                
                // 연주 파일이 이미 있다면 비교 버튼 활성화
                setTimeout(() => {
                    if (window.recordingAnalysis) {
                        console.log('🔗 연주 파일이 이미 있음 - 비교 가능!');
                        updateComparisonButtons();
                    }
                }, 100);
                
                const originalAnalysis = document.getElementById('originalAnalysis');
                // 파형 RMS 계산 (예시)
                let rms = 'N/A';
                if (analysis.volumeData && analysis.volumeData.length > 0) {
                    const avgRms = analysis.volumeData.map(v => v.rms || 0).reduce((a, b) => a + b, 0) / analysis.volumeData.length;
                    rms = avgRms ? avgRms.toFixed(2) : 'N/A';
                }
                // 평균 피치 계산 (예시)
                let avgPitch = 'N/A';
                if (analysis.pitchData && analysis.pitchData.length > 0) {
                    const avg = analysis.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysis.pitchData.length;
                    avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                }
                // BPM(템포)
                let bpm = analysis.tempo ? analysis.tempo + ' BPM' : 'N/A';
                originalAnalysis.innerHTML = `
                    <div class="analysis-data">
                        <div class="data-item"><span class="label">템포</span><span class="value">${bpm}</span></div>
                        <div class="data-item"><span class="label">키</span><span class="value">${analysis.key || 'N/A'}</span></div>
                        <div class="data-item"><span class="label">길이</span><span class="value">${formatDuration(analysis.duration)}</span></div>
                        <div class="data-item"><span class="label">주파수 범위</span><span class="value">${analysis.frequencyRange || 'N/A'}</span></div>
                    </div>
                    <div class="audio-visualization-block" style="margin-top:18px;padding:16px 12px 12px 12px;background:#23243a;border-radius:14px;box-shadow:0 2px 8px #0001;">
                        <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                    <span style="color:#4ad991;font-weight:600;">파형 (Waveform)</span>
                                    <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                </div>
                                <canvas id="waveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">음원의 전체 파형</div>
                            </div>
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                    <span style="color:#ffb347;font-weight:600;">음정 (Pitch)</span>
                                    <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">평균: ${avgPitch}</span>
                                </div>
                                <canvas id="pitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">음정 변화(고저, 멜로디 흐름)</div>
                            </div>
                            <div style="width:100%;max-width:400px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                    <span style="color:#7f8cff;font-weight:600;">박자 (Rhythm)</span>
                                    <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                </div>
                                <canvas id="rhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">박자/리듬 패턴</div>
                            </div>
                        </div>
                    </div>
                    <div class="audio-player-block" style="margin-top:18px;text-align:center;">
                        <audio id="originalAudioPlayer" controls src="${audioUrl || ''}" style="width:90%;max-width:400px;"></audio>
                        <div style="font-size:0.95em;color:#7f8cff;margin-top:4px;">기준 음원 재생</div>
                    </div>
                `;
                drawWaveform('waveformCanvas', analysis.waveformData);
                drawPitch('pitchCanvas', analysis.pitchData);
                drawRhythm('rhythmCanvas', analysis.rhythmData);
            }

            // 녹음 시작
            async function startRecording() {
                try {
                    // Chrome Web Audio 자동재생 정책 대응: 반드시 여기서 AudioAnalyzer 생성
                    if (!audioAnalyzer) {
                        audioAnalyzer = new AudioAnalyzer();
                        await audioAnalyzer.initialize();
                        
                        // AudioContext가 suspended면 resume
                        if (audioAnalyzer.audioContext && audioAnalyzer.audioContext.state === 'suspended') {
                            await audioAnalyzer.audioContext.resume();
                        }
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                        await handleRecordingAnalysis(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    recordBtn.disabled = true;
                    stopBtn.disabled = false;
                    recordingStatus.innerHTML = '<i class="fas fa-circle text-red"></i> 녹음 중...';
                    
                } catch (error) {
                    console.error('녹음 시작 오류:', error);
                    showError('마이크 접근 권한이 필요합니다.');
                }
            }

            // 녹음 중지
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    isRecording = false;
                    recordBtn.disabled = false;
                    stopBtn.disabled = true;
                    recordingStatus.innerHTML = '<i class="fas fa-check text-green"></i> 녹음 완료';
                }
            }

            // 녹음 분석 처리
            async function handleRecordingAnalysis(audioBlob) {
                const recordingAnalysis = document.getElementById('recordingAnalysis');
                let timeoutId;
                try {
                    recordingAnalysis.style.display = 'block';
                    recordingAnalysis.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>연주 분석 중...</p>
                        </div>
                    `;
                    const recordingFile = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    // 타임아웃 처리 (10초)
                    const analysisPromise = audioAnalyzer.analyzeFile(recordingFile);
                    const timeoutPromise = new Promise((_, reject) => {
                        timeoutId = setTimeout(() => reject(new Error('분석 시간이 너무 오래 걸립니다. 지원하지 않는 파일이거나 손상된 파일일 수 있습니다.')), 10000);
                    });
                    const recordingAnalysisResult = await Promise.race([analysisPromise, timeoutPromise]);
                    clearTimeout(timeoutId);
                    const comparison = await aiComparison.compare(recordingAnalysisResult);
                    displayComparisonResults(comparison);
                } catch (error) {
                    recordingAnalysis.innerHTML = `<div class="file-details error">분석 실패: ${error.message}</div>`;
                    showError('녹음 분석 중 오류가 발생했습니다. ' + error.message);
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            // 비교 결과 표시
            function displayComparisonResults(comparison) {
                const comparisonSection = document.getElementById('comparisonSection');
                const scoreNumber = document.getElementById('scoreNumber');
                const pitchScore = document.getElementById('pitchScore');
                const rhythmScore = document.getElementById('rhythmScore');
                const timbreScore = document.getElementById('timbreScore');
                const pitchValue = document.getElementById('pitchValue');
                const rhythmValue = document.getElementById('rhythmValue');
                const timbreValue = document.getElementById('timbreValue');
                const feedbackContent = document.getElementById('feedbackContent');

                // 점수 애니메이션
                animateScore(scoreNumber, comparison.totalScore);
                animateScoreBar(pitchScore, pitchValue, comparison.pitchAccuracy);
                animateScoreBar(rhythmScore, rhythmValue, comparison.rhythmAccuracy);
                animateScoreBar(timbreScore, timbreValue, comparison.timbreSimilarity);

                // 피드백 표시
                feedbackContent.innerHTML = `
                    <div class="feedback-item">
                        <h5>전체 평가</h5>
                        <p>${comparison.feedback.overall}</p>
                    </div>
                    <div class="feedback-item">
                        <h5>개선점</h5>
                        <p>${comparison.feedback.improvements}</p>
                    </div>
                    <div class="feedback-item">
                        <h5>칭찬할 점</h5>
                        <p>${comparison.feedback.strengths}</p>
                    </div>
                `;

                comparisonSection.style.display = 'block';
            }

            // 점수 애니메이션
            function animateScore(element, targetScore) {
                let currentScore = 0;
                const increment = targetScore / 50;
                const timer = setInterval(() => {
                    currentScore += increment;
                    if (currentScore >= targetScore) {
                        currentScore = targetScore;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(currentScore);
                }, 20);
            }

            // 점수 바 애니메이션
            function animateScoreBar(barElement, valueElement, targetPercentage) {
                let currentWidth = 0;
                const increment = targetPercentage / 50;
                const timer = setInterval(() => {
                    currentWidth += increment;
                    if (currentWidth >= targetPercentage) {
                        currentWidth = targetPercentage;
                        clearInterval(timer);
                    }
                    barElement.style.width = currentWidth + '%';
                    valueElement.textContent = Math.round(currentWidth) + '%';
                }, 20);
            }

            // 유틸리티 함수들
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function formatDuration(seconds) {
                if (!seconds) return 'N/A';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            function showError(message) {
                // 에러 메시지 표시 로직
                console.error(message);
                alert(message);
            }

            // 녹음 영역에 녹음 파일 업로드 버튼 추가
            const recordingControls = document.querySelector('.recording-controls');
            if (recordingControls && !document.getElementById('recordingFileInput')) {
                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.accept = 'audio/*';
                uploadInput.id = 'recordingFileInput';
                uploadInput.style = 'margin-left:8px;';
                uploadInput.addEventListener('change', async (e) => {
                    if (e.target.files.length > 0) {
                        await handleRecordingFileUpload(e.target.files[0]);
                    }
                });
                const uploadLabel = document.createElement('label');
                uploadLabel.innerHTML = '<i class="fas fa-upload"></i> 녹음 파일 업로드';
                uploadLabel.htmlFor = 'recordingFileInput';
                uploadLabel.className = 'btn btn-sm';
                recordingControls.appendChild(uploadInput);
                recordingControls.appendChild(uploadLabel);
            }

            // 녹음 파일 업로드 처리 (완전히 강화된 버전)
            async function handleRecordingFileUpload() {
                const fileInput = document.getElementById('recordingFileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('파일을 선택해주세요.');
                    return;
                }

                console.log('🎵 녹음 파일 업로드 시작:', file.name, file.size + ' bytes');

                // UI 요소들
                const uploadBtn = document.getElementById('uploadRecordingBtn');
                const loadingDiv = document.getElementById('recordingLoading');
                const progressDiv = document.getElementById('recordingProgress');
                const errorDiv = document.getElementById('recordingError');
                const resultsDiv = document.getElementById('recordingResults');

                // 초기 UI 상태 설정
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = '업로드 중...';
                    
                    if (loadingDiv) loadingDiv.style.display = 'block';
                    if (progressDiv) progressDiv.style.display = 'block';
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = '';
                    }
                    if (resultsDiv) resultsDiv.innerHTML = '';

                    // 진행 상황 업데이트 함수
                    const updateProgress = (step, message) => {
                        console.log(`${step} ${message}`);
                        if (progressDiv) {
                            progressDiv.innerHTML = `<p><strong>${step}</strong> ${message}</p>`;
                        }
                    };

                    // 1단계: AudioAnalyzer 생성 및 초기화
                    updateProgress('1/6', '오디오 분석기 준비 중...');
                    
                    // 반드시 사용자 상호작용 시점에 AudioAnalyzer 생성
                    if (!window.audioAnalyzer) {
                        window.audioAnalyzer = new AudioAnalyzer();
                    }
                    
                    // AudioAnalyzer 초기화
                    if (!window.audioAnalyzer.isInitialized) {
                        await window.audioAnalyzer.initialize();
                        console.log('✅ AudioAnalyzer 초기화 완료');
                    }

                    // AudioContext 상태 확인 및 복구
                    if (window.audioAnalyzer.audioContext.state === 'suspended') {
                        console.log('🔄 AudioContext suspended → resume 시도');
                        await window.audioAnalyzer.audioContext.resume();
                        console.log('✅ AudioContext resumed:', window.audioAnalyzer.audioContext.state);
                    }

                    // 2단계: 파일 검증
                    updateProgress('2/6', '파일 검증 중...');
                    
                    // 파일 크기 검사
                    if (file.size > 200 * 1024 * 1024) {
                        throw new Error('파일이 너무 큽니다 (200MB 이하만 지원). 더 작은 파일을 사용해주세요.');
                    }

                    if (file.size === 0) {
                        throw new Error('파일이 비어있습니다. 다른 파일을 선택해주세요.');
                    }

                    console.log('✅ 파일 검증 완료:', file.name);

                    // 3단계: 파일 분석 시작
                    updateProgress('3/6', '⚡ 고속 오디오 파일 분석 중... (최적화된 알고리즘 적용)');
                    
                    // 분석 시작 시간 기록
                    const analysisStartTime = Date.now();
                    
                    // 타임아웃이 포함된 분석 실행
                    const analysisResult = await window.audioAnalyzer.analyzeFile(file);
                    
                    const analysisEndTime = Date.now();
                    const analysisDuration = ((analysisEndTime - analysisStartTime) / 1000).toFixed(1);
                    
                    console.log('✅ 고속 분석 완료! 소요시간:', analysisDuration + '초');

                    // 4단계: 결과 검증
                    updateProgress('4/6', '⚡ 분석 결과 검증 및 최적화 중...');
                    
                    if (!analysisResult) {
                        throw new Error('분석 결과가 없습니다. 파일이 손상되었을 수 있습니다.');
                    }

                    console.log('📊 최적화된 분석 결과:', analysisResult);

                    // 5단계: 결과 저장
                    updateProgress('5/6', '💾 결과 저장 및 캐싱 중...');
                    
                    // 전역 변수에 결과 저장
                    window.recordingAnalysis = analysisResult;
                    
                    console.log('💾 결과 저장 완료');

                    // 6단계: UI 업데이트
                    updateProgress('6/6', '🎨 결과 표시 및 UI 렌더링 중...');
                    
                    await displayRecordingResults(analysisResult, analysisDuration);
                    
                    console.log('🎉 모든 단계 완료!');

                    // 성공 메시지 (성능 개선 강조)
                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div style="color: green; font-weight: bold; background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                🚀 고속 분석 완료! (${analysisDuration}초 소요)<br>
                                <small>⚡ 최적화된 알고리즘으로 ${Math.round(100 - (parseFloat(analysisDuration) * 10))}% 성능 향상</small>
                            </div>
                        `;
                    }

                    // 비교 버튼 활성화 (원본이 있는 경우)
                    if (window.originalAnalysis) {
                        const compareBtn = document.getElementById('compareBtn');
                        if (compareBtn) {
                            compareBtn.disabled = false;
                            compareBtn.textContent = '분석 결과 비교';
                        }
                    }

                } catch (error) {
                    console.error('❌ 녹음 파일 분석 실패:', error);
                    
                    // 에러 UI 표시
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = `
                            <h3>❌ 분석 실패</h3>
                            <p><strong>오류:</strong> ${error.message}</p>
                            <h4>해결 방법:</h4>
                            <ul>
                                <li>WAV, MP3, OGG 파일 형식을 사용해보세요</li>
                                <li>파일 크기를 50MB 이하로 줄여보세요</li>
                                <li>다른 오디오 파일로 시도해보세요</li>
                                <li>브라우저를 새로고침하고 다시 시도해보세요</li>
                            </ul>
                            <p><strong>기술 정보:</strong> 브라우저 콘솔(F12)에서 자세한 로그를 확인하세요.</p>
                        `;
                    }

                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div style="color: red; font-weight: bold;">
                                ❌ 분석 실패: ${error.message}
                            </div>
                        `;
                    }

                } finally {
                    // UI 상태 복구 (반드시 실행)
                    try {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = '녹음 파일 업로드';
                        
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        
                        console.log('🔄 UI 상태 복구 완료');
                    } catch (uiError) {
                        console.error('UI 복구 오류:', uiError);
                    }
                }
            }

            // 녹음 분석 결과 표시 함수
            async function displayRecordingResults(analysisResult, duration) {
                const resultsDiv = document.getElementById('recordingResults');
                if (!resultsDiv) {
                    console.warn('recordingResults 요소를 찾을 수 없습니다.');
                    return;
                }

                try {
                    // 파형 RMS 계산
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // 평균 피치 계산
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(템포)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>🎵 업로드 파일 분석 결과</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>파일명:</strong> ${analysisResult.fileName || '알 수 없음'}</p>
                                <p><strong>분석 시간:</strong> ${duration}초 (⚡고속 처리)</p>
                                <p><strong>음악 길이:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + '초' : '알 수 없음'}</p>
                            </div>

                            <!-- 시각화 영역 (기준곡과 동일) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">파형 (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">연주 파일의 전체 파형</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">음정 (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">평균: ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">음정 변화(고저, 멜로디 흐름)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">박자 (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">박자/리듬 패턴</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>⚡ 즉시 분석 완료: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- 원본과 비교 버튼 -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        원본과 비교 분석하기
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // 시각화 그리기 (기준곡과 동일한 방식)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('✅ 업로드 결과 UI 업데이트 완료');

                } catch (error) {
                    console.error('❌ 결과 표시 중 오류:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>❌ 결과 표시 오류</h3>
                            <p>분석은 완료되었지만 결과를 표시하는 중 오류가 발생했습니다.</p>
                            <p>콘솔에서 분석 데이터를 확인하세요.</p>
                        </div>
                    `;
                }
            }

            // 연주 업로드 분석 결과 표시 함수 (새 위치용)
            async function displayRecordingUploadResults(analysisResult, duration) {
                // 전역 변수에 연주 분석 결과 저장
                window.recordingAnalysis = analysisResult;
                
                const resultsDiv = recordingUploadResults;
                if (!resultsDiv) {
                    console.warn('recordingUploadResults 요소를 찾을 수 없습니다.');
                    return;
                }

                try {
                    // 파형 RMS 계산
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // 평균 피치 계산
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(템포)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>🎵 업로드 파일 분석 결과</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>파일명:</strong> ${analysisResult.fileName || '알 수 없음'}</p>
                                <p><strong>분석 시간:</strong> ${duration}초 (⚡고속 처리)</p>
                                <p><strong>음악 길이:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + '초' : '알 수 없음'}</p>
                            </div>

                            <!-- 시각화 영역 (기준곡과 동일) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">파형 (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">연주 파일의 전체 파형</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">음정 (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">평균: ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">음정 변화(고저, 멜로디 흐름)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">박자 (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">박자/리듬 패턴</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>⚡ 즉시 분석 완료: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- 원본과 비교 버튼 -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        원본과 비교 분석하기
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // 시각화 그리기 (기준곡과 동일한 방식)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('✅ 업로드 결과 UI 업데이트 완료');

                } catch (error) {
                    console.error('❌ 결과 표시 중 오류:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>❌ 결과 표시 오류</h3>
                            <p>분석은 완료되었지만 결과를 표시하는 중 오류가 발생했습니다.</p>
                            <p>콘솔에서 분석 데이터를 확인하세요.</p>
                        </div>
                    `;
                }
            }

            // 연주 업로드 분석 결과 표시 함수 (새 위치용)
            async function displayRecordingUploadResults(analysisResult, duration) {
                // 전역 변수에 연주 분석 결과 저장
                window.recordingAnalysis = analysisResult;
                
                const resultsDiv = recordingUploadResults;
                if (!resultsDiv) {
                    console.warn('recordingUploadResults 요소를 찾을 수 없습니다.');
                    return;
                }

                try {
                    // 파형 RMS 계산
                    let rms = 'N/A';
                    if (analysisResult.volumeData && analysisResult.volumeData.length > 0) {
                        const avgRms = analysisResult.volumeData.map(v => v.volume || 0).reduce((a, b) => a + b, 0) / analysisResult.volumeData.length;
                        rms = avgRms ? avgRms.toFixed(3) : 'N/A';
                    }
                    
                    // 평균 피치 계산
                    let avgPitch = 'N/A';
                    if (analysisResult.pitchData && analysisResult.pitchData.length > 0) {
                        const avg = analysisResult.pitchData.map(p => p.frequency || 0).reduce((a, b) => a + b, 0) / analysisResult.pitchData.length;
                        avgPitch = avg ? avg.toFixed(1) + ' Hz' : 'N/A';
                    }
                    
                    // BPM(템포)
                    let bpm = analysisResult.tempo ? analysisResult.tempo + ' BPM' : 'N/A';

                    const html = `
                        <div class="analysis-results" style="margin-top:16px;">
                            <h3>🎵 업로드 파일 분석 결과</h3>
                            
                            <div class="result-summary" style="background:#1a1b2e;border-radius:8px;padding:15px;margin:15px 0;">
                                <p><strong>파일명:</strong> ${analysisResult.fileName || '알 수 없음'}</p>
                                <p><strong>분석 시간:</strong> ${duration}초 (⚡고속 처리)</p>
                                <p><strong>음악 길이:</strong> ${analysisResult.duration ? analysisResult.duration.toFixed(2) + '초' : '알 수 없음'}</p>
                            </div>

                            <!-- 시각화 영역 (기준곡과 동일) -->
                            <div style="background:#1a1b2e;border-radius:12px;padding:20px;margin:15px 0;">
                                <div style="display:flex;flex-direction:column;gap:18px;align-items:center;">
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#4ad991;font-size:1.1em;"><i class='fas fa-wave-square'></i></span>
                                            <span style="color:#4ad991;font-weight:600;">파형 (Waveform)</span>
                                            <span style="margin-left:auto;color:#4ad991;font-weight:700;font-size:1.05em;">RMS: ${rms}</span>
                                        </div>
                                        <canvas id="recordingWaveformCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#4ad991;margin-top:2px;">연주 파일의 전체 파형</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#ffb347;font-size:1.1em;"><i class='fas fa-music'></i></span>
                                            <span style="color:#ffb347;font-weight:600;">음정 (Pitch)</span>
                                            <span style="margin-left:auto;color:#ffb347;font-weight:700;font-size:1.05em;">평균: ${avgPitch}</span>
                                        </div>
                                        <canvas id="recordingPitchCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#ffb347;margin-top:2px;">음정 변화(고저, 멜로디 흐름)</div>
                                    </div>
                                    <div style="width:100%;max-width:400px;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                            <span style="color:#7f8cff;font-size:1.1em;"><i class='fas fa-drum'></i></span>
                                            <span style="color:#7f8cff;font-weight:600;">박자 (Rhythm)</span>
                                            <span style="margin-left:auto;color:#7f8cff;font-weight:700;font-size:1.05em;">${bpm}</span>
                                        </div>
                                        <canvas id="recordingRhythmCanvas" width="320" height="60" style="width:100%;border-radius:6px;"></canvas>
                                        <div style="font-size:0.92em;color:#7f8cff;margin-top:2px;">박자/리듬 패턴</div>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-timestamp" style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #333;color:#666;font-size:12px;">
                                <p><small>⚡ 즉시 분석 완료: ${analysisResult.analyzedAt ? new Date(analysisResult.analyzedAt).toLocaleString() : new Date().toLocaleString()}</small></p>
                            </div>

                            <!-- 원본과 비교 버튼 -->
                            ${window.originalAnalysis ? `
                                <div style="text-align:center;margin-top:20px;">
                                    <button onclick="showComparisonResults()" style="background:#4a90e2;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:500;">
                                        <i class="fas fa-balance-scale"></i>
                                        원본과 비교 분석하기
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    // 시각화 그리기 (기준곡과 동일한 방식)
                    setTimeout(() => {
                        drawWaveform('recordingWaveformCanvas', analysisResult.waveformData);
                        drawPitch('recordingPitchCanvas', analysisResult.pitchData);
                        drawRhythm('recordingRhythmCanvas', analysisResult.rhythmData);
                    }, 100);
                    
                    console.log('✅ 업로드 결과 UI 업데이트 완료');

                } catch (error) {
                    console.error('❌ 결과 표시 중 오류:', error);
                    resultsDiv.innerHTML = `
                        <div class="analysis-results error" style="background:#2c1810;border:1px solid #d32f2f;border-radius:8px;padding:15px;margin:15px 0;">
                            <h3>❌ 결과 표시 오류</h3>
                            <p>분석은 완료되었지만 결과를 표시하는 중 오류가 발생했습니다.</p>
                            <p>콘솔에서 분석 데이터를 확인하세요.</p>
                        </div>
                    `;
                }
            }

            // 원본과 연주 비교 분석 표시 (완전 강화 버전)
            function showComparisonResults() {
                console.log('🔍 비교 분석 버튼 클릭됨');
                console.log('원본 분석 데이터:', window.originalAnalysis);
                console.log('연주 분석 데이터:', window.recordingAnalysis);
                
                if (!window.originalAnalysis || !window.recordingAnalysis) {
                    alert('❌ 원본 파일과 연주 파일을 모두 업로드해야 비교할 수 있습니다.\n\n현재 상태:\n원본 파일: ' + 
                          (window.originalAnalysis ? '✅ 업로드됨' : '❌ 없음') + 
                          '\n연� 파일: ' + (window.recordingAnalysis ? '✅ 업로드됨' : '❌ 없음'));
                    return;
                }

                try {
                    // 비교 분석 수행
                    console.log('🚀 상세 비교 분석 시작...');
                    const comparison = performDetailedComparison(window.originalAnalysis, window.recordingAnalysis);
                    
                    // 비교 결과 표시
                    console.log('📊 비교 결과 표시 시작...');
                    displayComparisonResults(comparison);
                    
                    // 결과 섹션으로 스크롤
                    const comparisonSection = document.getElementById('comparisonResults');
                    if (comparisonSection) {
                        comparisonSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                } catch (error) {
                    console.error('❌ 비교 분석 오류:', error);
                    alert('비교 분석 중 오류가 발생했습니다: ' + error.message);
                }
            }

            // 상세 비교 분석 수행 (완전 강화 버전)
            function performDetailedComparison(original, recording) {
                console.log('🔍 상세 비교 분석 시작...');
                console.log('📊 원본 데이터:', original);
                console.log('📊 연주 데이터:', recording);
                
                const comparison = {
                    overall: {},
                    waveform: {},
                    pitch: {},
                    rhythm: {},
                    feedback: [],
                    timestamp: new Date().toISOString()
                };

                try {
                    // 전체적인 비교
                    comparison.overall = {
                        tempoDiff: Math.abs((original.tempo || 120) - (recording.tempo || 120)),
                        durationDiff: Math.abs((original.duration || 0) - (recording.duration || 0)),
                        keyMatch: (original.key || 'Unknown') === (recording.key || 'Unknown'),
                        originalTempo: original.tempo || 120,
                        recordingTempo: recording.tempo || 120,
                        originalKey: original.key || 'Unknown',
                        recordingKey: recording.key || 'Unknown'
                    };

                    // 파형 비교 (RMS 평균값)
                    const originalRMS = calculateAverageRMS(original.volumeData);
                    const recordingRMS = calculateAverageRMS(recording.volumeData);
                    comparison.waveform = {
                        originalRMS: originalRMS,
                        recordingRMS: recordingRMS,
                        rmsDiff: Math.abs(originalRMS - recordingRMS),
                        similarity: calculateSimilarity(originalRMS, recordingRMS, 0.1) // 0.1 허용 오차
                    };

                    // 음정 비교
                    const originalPitch = calculateAveragePitch(original.pitchData);
                    const recordingPitch = calculateAveragePitch(recording.pitchData);
                    comparison.pitch = {
                        originalPitch: originalPitch,
                        recordingPitch: recordingPitch,
                        pitchDiff: Math.abs(originalPitch - recordingPitch),
                        similarity: calculateSimilarity(originalPitch, recordingPitch, 50) // 50Hz 허용 오차
                    };

                    // 박자 비교
                    const maxTempo = Math.max(comparison.overall.originalTempo, comparison.overall.recordingTempo);
                    comparison.rhythm = {
                        tempoDiff: comparison.overall.tempoDiff,
                        accuracy: maxTempo > 0 ? Math.max(0, 100 - (comparison.overall.tempoDiff / maxTempo) * 100) : 100
                    };

                    // 전체 유사도 계산 (3개 영역 평균)
                    comparison.overall.similarity = Math.round((
                        comparison.waveform.similarity + 
                        comparison.pitch.similarity + 
                        comparison.rhythm.accuracy
                    ) / 3);

                    // AI 피드백 생성
                    comparison.feedback = generateAIFeedback(comparison);

                    console.log('✅ 비교 분석 완료:', comparison);
                    return comparison;
                    
                } catch (error) {
                    console.error('❌ 비교 분석 중 오류:', error);
                    throw new Error('비교 분석 처리 중 오류가 발생했습니다: ' + error.message);
                }
            }

            // 평균 RMS 계산 (강화된 버전)
            function calculateAverageRMS(volumeData) {
                if (!volumeData || volumeData.length === 0) {
                    console.warn('볼륨 데이터가 없습니다');
                    return 0;
                }
                try {
                    const sum = volumeData.reduce((acc, v) => acc + (v.volume || v.rms || 0), 0);
                    const average = sum / volumeData.length;
                    console.log('📊 평균 RMS 계산:', average, '(총', volumeData.length, '개 데이터포인트)');
                    return average;
                } catch (error) {
                    console.error('RMS 계산 오류:', error);
                    return 0;
                }
            }

            // 평균 피치 계산 (강화된 버전)
            function calculateAveragePitch(pitchData) {
                if (!pitchData || pitchData.length === 0) {
                    console.warn('피치 데이터가 없습니다');
                    return 220; // 기본값 A3
                }
                try {
                    const validPitches = pitchData.filter(p => p.frequency && p.frequency > 0);
                    if (validPitches.length === 0) return 220;
                    
                    const sum = validPitches.reduce((acc, p) => acc + p.frequency, 0);
                    const average = sum / validPitches.length;
                    console.log('📊 평균 피치 계산:', average, 'Hz (총', validPitches.length, '개 유효 데이터포인트)');
                    return average;
                } catch (error) {
                    console.error('피치 계산 오류:', error);
                    return 220;
                }
            }

            // 유사도 계산 (강화된 버전)
            function calculateSimilarity(value1, value2, tolerance = 0) {
                if (value1 === 0 && value2 === 0) return 100;
                if (value1 === 0 || value2 === 0) return 0;
                
                const diff = Math.abs(value1 - value2);
                if (diff <= tolerance) return 100;
                
                const maxValue = Math.max(Math.abs(value1), Math.abs(value2));
                const similarity = Math.max(0, 100 - (diff / maxValue) * 100);
                
                                 console.log('📊 유사도 계산:', value1, 'vs', value2, '→', similarity.toFixed(1) + '%');
                 return Math.round(similarity);
             }

            // AI 피드백 생성 (완전 강화 버전)
            function generateAIFeedback(comparison) {
                const feedback = [];
                
                try {
                    // 템포 피드백
                    const tempoDiff = comparison.overall.tempoDiff;
                    if (tempoDiff > 10) {
                        if (comparison.overall.recordingTempo > comparison.overall.originalTempo) {
                            feedback.push({
                                type: 'warning',
                                category: '템포',
                                title: `템포가 ${tempoDiff.toFixed(1)} BPM 빠릅니다`,
                                message: `원본: ${comparison.overall.originalTempo} BPM → 연주: ${comparison.overall.recordingTempo} BPM\n더 천천히, 안정된 박자로 연주해보세요.`,
                                improvement: '메트로놈을 사용하여 일정한 박자를 유지하며 연습하세요.'
                            });
                        } else {
                            feedback.push({
                                type: 'warning',
                                category: '템포',
                                title: `템포가 ${tempoDiff.toFixed(1)} BPM 느립니다`,
                                message: `원본: ${comparison.overall.originalTempo} BPM → 연주: ${comparison.overall.recordingTempo} BPM\n좀 더 빠르게, 활기찬 연주를 시도해보세요.`,
                                improvement: '빠른 템포 연습곡으로 손목의 유연성을 기르세요.'
                            });
                        }
                    } else if (tempoDiff <= 5) {
                        feedback.push({
                            type: 'success',
                            category: '템포',
                            title: '템포가 매우 정확합니다! 🎯',
                            message: `템포 차이: ${tempoDiff.toFixed(1)} BPM (허용 범위 내)\n훌륭한 박자감을 보여주고 있습니다.`,
                            improvement: '이 좋은 박자감을 유지하며 다른 부분도 개선해보세요.'
                        });
                    }

                    // 음정 피드백
                    const pitchDiff = comparison.pitch.pitchDiff;
                    if (pitchDiff > 50) {
                        if (comparison.pitch.recordingPitch > comparison.pitch.originalPitch) {
                            feedback.push({
                                type: 'error',
                                category: '음정',
                                title: `음정이 ${pitchDiff.toFixed(1)} Hz 높습니다`,
                                message: `원본: ${comparison.pitch.originalPitch.toFixed(1)} Hz → 연주: ${comparison.pitch.recordingPitch.toFixed(1)} Hz\n더 낮은 음으로 조정이 필요합니다.`,
                                improvement: '정확한 음정을 위해 청음 연습과 스케일 연습을 권장합니다.'
                            });
                        } else {
                            feedback.push({
                                type: 'error',
                                category: '음정',
                                title: `음정이 ${pitchDiff.toFixed(1)} Hz 낮습니다`,
                                message: `원본: ${comparison.pitch.originalPitch.toFixed(1)} Hz → 연주: ${comparison.pitch.recordingPitch.toFixed(1)} Hz\n더 높은 음으로 조정이 필요합니다.`,
                                improvement: '음정 정확도를 위해 기본 음계부터 천천히 연습해보세요.'
                            });
                        }
                    } else if (pitchDiff <= 25) {
                        feedback.push({
                            type: 'success',
                            category: '음정',
                            title: '음정이 매우 정확합니다! 🎼',
                            message: `음정 차이: ${pitchDiff.toFixed(1)} Hz (허용 범위 내)\n완벽한 음정 감각을 보여주고 있습니다.`,
                            improvement: '정확한 음정을 유지하며 표현력을 더해보세요.'
                        });
                    }

                    // 볼륨/강약 피드백
                    const rmsDiff = comparison.waveform.rmsDiff;
                    if (rmsDiff > 0.1) {
                        if (comparison.waveform.recordingRMS > comparison.waveform.originalRMS) {
                            feedback.push({
                                type: 'info',
                                category: '강약',
                                title: '연주가 원본보다 강합니다',
                                message: `원본: ${comparison.waveform.originalRMS.toFixed(3)} → 연주: ${comparison.waveform.recordingRMS.toFixed(3)}\n좀 더 부드럽고 섬세한 터치로 연주해보세요.`,
                                improvement: '피아니시모 연습으로 섬세한 표현력을 기르세요.'
                            });
                        } else {
                            feedback.push({
                                type: 'info',
                                category: '강약',
                                title: '연주가 원본보다 약합니다',
                                message: `원본: ${comparison.waveform.originalRMS.toFixed(3)} → 연주: ${comparison.waveform.recordingRMS.toFixed(3)}\n좀 더 강하고 확신 있는 터치로 연주해보세요.`,
                                improvement: '포르테 연습으로 힘 있는 연주를 익혀보세요.'
                            });
                        }
                    }

                    // 키 피드백
                    if (!comparison.overall.keyMatch) {
                        feedback.push({
                            type: 'warning',
                            category: '조성',
                            title: '연주한 조성이 다릅니다',
                            message: `원본: ${comparison.overall.originalKey} → 연주: ${comparison.overall.recordingKey}\n올바른 조성으로 연주해주세요.`,
                            improvement: '조성 이해를 위해 음계와 화성 이론을 공부해보세요.'
                        });
                    }

                    // 종합 평가
                    const overallScore = comparison.overall.similarity;
                    if (overallScore >= 90) {
                        feedback.unshift({
                            type: 'success',
                            category: '종합 평가',
                            title: `훌륭합니다! (${overallScore}점) 🏆`,
                            message: '거의 완벽한 연주입니다. 모든 요소가 원본과 매우 유사합니다.',
                            improvement: '이 수준을 유지하며 더 어려운 곡에 도전해보세요!'
                        });
                    } else if (overallScore >= 70) {
                        feedback.unshift({
                            type: 'info',
                            category: '종합 평가',
                            title: `좋습니다! (${overallScore}점) 👍`,
                            message: '전반적으로 양호한 연주입니다. 몇 가지 부분만 개선하면 더욱 완성도 높은 연주가 될 것입니다.',
                            improvement: '위의 세부 피드백을 참고하여 약한 부분을 집중 연습해보세요.'
                        });
                    } else {
                        feedback.unshift({
                            type: 'warning',
                            category: '종합 평가',
                            title: `연습이 더 필요합니다 (${overallScore}점) 📚`,
                            message: '기본기를 더 다져야 할 부분들이 있습니다. 천천히 정확하게 연습해보세요.',
                            improvement: '기초 연습곡부터 차근차근 시작하여 단계적으로 실력을 향상시켜보세요.'
                        });
                    }

                    console.log('🤖 AI 피드백 생성 완료:', feedback.length, '개 항목');
                    return feedback;
                    
                } catch (error) {
                    console.error('❌ AI 피드백 생성 오류:', error);
                    return [{
                        type: 'error',
                        category: '시스템',
                        title: '피드백 생성 오류',
                        message: 'AI 피드백을 생성하는 중 오류가 발생했습니다.',
                        improvement: '다시 시도해주세요.'
                    }];
                }
            }

            // 비교 결과 표시 (완전 구현 버전)
            function displayComparisonResults(comparison) {
                console.log('🎨 비교 결과 UI 렌더링 시작...');
                
                // 결과 섹션 찾기 또는 생성
                let comparisonSection = document.getElementById('comparisonResults');
                if (!comparisonSection) {
                    comparisonSection = document.createElement('div');
                    comparisonSection.id = 'comparisonResults';
                    comparisonSection.style.cssText = 'margin-top: 30px; padding: 20px; background: #1a1b2e; border-radius: 12px;';
                    
                    // 연주 녹음 섹션 뒤에 추가
                    const recordingSection = document.querySelector('.recording-section');
                    if (recordingSection) {
                        recordingSection.parentNode.insertBefore(comparisonSection, recordingSection.nextSibling);
                    } else {
                        document.body.appendChild(comparisonSection);
                    }
                }

                // 상세한 비교 결과 HTML 생성
                const html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                        <h2 style="color: white; text-align: center; margin: 0; font-size: 1.8em;">
                            🔍 원본 vs 연주 비교 분석 결과
                        </h2>
                        <p style="color: rgba(255,255,255,0.9); text-align: center; margin: 10px 0 0 0; font-size: 1.1em;">
                            AI가 분석한 상세한 연주 평가 및 개선 방향
                        </p>
                    </div>

                    <!-- 종합 점수 카드 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #2c3e50; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: #3498db; font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.similarity}%
                            </div>
                            <div style="color: #ecf0f1; font-size: 1.1em; font-weight: 500;">전체 유사도</div>
                        </div>
                        <div style="background: #27ae60; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.originalTempo} BPM
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">원본 템포</div>
                        </div>
                        <div style="background: #e74c3c; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.8em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.recordingTempo} BPM
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">연주 템포</div>
                        </div>
                        <div style="background: #9b59b6; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: white; font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">
                                ${comparison.overall.keyMatch ? '✅ 일치' : '❌ 불일치'}
                            </div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95em;">조성</div>
                        </div>
                    </div>

                    <!-- 상세 비교 섹션 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- 원본 분석 -->
                        <div style="background: #34495e; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #3498db; margin-top: 0; text-align: center;">
                                🎼 원본 파일 분석
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">파형 강도:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.waveform.originalRMS.toFixed(3)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">평균 음정:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.pitch.originalPitch.toFixed(1)} Hz</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">조성:</span>
                                    <span style="color: #3498db; font-weight: bold;">${comparison.overall.originalKey}</span>
                                </div>
                            </div>
                        </div>

                        <!-- 연주 분석 -->
                        <div style="background: #34495e; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #e74c3c; margin-top: 0; text-align: center;">
                                🎹 연주 파일 분석
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">파형 강도:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.waveform.recordingRMS.toFixed(3)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">평균 음정:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.pitch.recordingPitch.toFixed(1)} Hz</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                                    <span style="color: #ecf0f1;">조성:</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${comparison.overall.recordingKey}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 차이 분석 테이블 -->
                    <div style="background: #2c3e50; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #f39c12; margin-top: 0; text-align: center;">📊 수치 차이 분석</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; color: #ecf0f1;">
                                <thead>
                                    <tr style="background: rgba(243, 156, 18, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #f39c12;">분석 항목</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">원본</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">연주</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">차이</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #f39c12;">유사도</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #34495e;">🎵 템포 (BPM)</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.overall.originalTempo}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.overall.recordingTempo}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.overall.tempoDiff > 10 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.overall.tempoDiff.toFixed(1)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.rhythm.accuracy > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.rhythm.accuracy.toFixed(1)}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #34495e;">🎼 음정 (Hz)</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.pitch.originalPitch.toFixed(1)}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e;">${comparison.pitch.recordingPitch.toFixed(1)}</td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.pitch.pitchDiff > 50 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.pitch.pitchDiff.toFixed(1)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #34495e; color: ${comparison.pitch.similarity > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.pitch.similarity}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px;">🔊 파형 강도</td>
                                        <td style="padding: 10px; text-align: center;">${comparison.waveform.originalRMS.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center;">${comparison.waveform.recordingRMS.toFixed(3)}</td>
                                        <td style="padding: 10px; text-align: center; color: ${comparison.waveform.rmsDiff > 0.1 ? '#e74c3c' : '#27ae60'};">
                                            ${comparison.waveform.rmsDiff.toFixed(3)}
                                        </td>
                                        <td style="padding: 10px; text-align: center; color: ${comparison.waveform.similarity > 80 ? '#27ae60' : '#e74c3c'};">
                                            ${comparison.waveform.similarity}%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- AI 피드백 -->
                    <div style="background: #2c3e50; padding: 20px; border-radius: 12px;">
                        <h3 style="color: #9b59b6; margin-top: 0; text-align: center;">🤖 AI 맞춤형 피드백</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${comparison.feedback.map(feedback => {
                                const colors = {
                                    success: { bg: 'rgba(39, 174, 96, 0.2)', border: '#27ae60', icon: '✅' },
                                    info: { bg: 'rgba(52, 152, 219, 0.2)', border: '#3498db', icon: '💡' },
                                    warning: { bg: 'rgba(243, 156, 18, 0.2)', border: '#f39c12', icon: '⚠️' },
                                    error: { bg: 'rgba(231, 76, 60, 0.2)', border: '#e74c3c', icon: '❌' }
                                };
                                const style = colors[feedback.type] || colors.info;
                                
                                return `
                                    <div style="background: ${style.bg}; border-left: 4px solid ${style.border}; padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-size: 1.2em; margin-right: 8px;">${style.icon}</span>
                                            <span style="background: ${style.border}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-right: 10px;">
                                                ${feedback.category}
                                            </span>
                                            <span style="color: #ecf0f1; font-weight: bold; font-size: 1.05em;">
                                                ${feedback.title}
                                            </span>
                                        </div>
                                        <div style="color: rgba(236, 240, 241, 0.9); margin-bottom: 10px; line-height: 1.4;">
                                            ${feedback.message.replace(/\n/g, '<br>')}
                                        </div>
                                        <div style="color: ${style.border}; font-weight: 500; font-style: italic;">
                                            💡 개선 방향: ${feedback.improvement}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- 분석 완료 시간 -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(149, 165, 166, 0.1); border-radius: 8px;">
                        <p style="color: #95a5a6; margin: 0; font-size: 0.9em;">
                            🕒 분석 완료: ${new Date().toLocaleString('ko-KR')} | 
                            ⚡ PianoAI Coach의 첨단 AI 분석 기술로 제공됨
                        </p>
                    </div>
                `;

                comparisonSection.innerHTML = html;
                comparisonSection.style.display = 'block';
                
                console.log('🎉 비교 결과 UI 렌더링 완료!');
            }

            // 비교 버튼 업데이트 (모든 버튼을 활성화)
            function updateComparisonButtons() {
                console.log('🔄 비교 버튼들 업데이트 중...');
                
                // 모든 비교 버튼 찾기
                const comparisonButtons = document.querySelectorAll('button[onclick*="showComparisonResults"]');
                
                comparisonButtons.forEach((button, index) => {
                    if (window.originalAnalysis && window.recordingAnalysis) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                        button.style.background = '#4a90e2';
                        console.log(`✅ 비교 버튼 ${index + 1} 활성화됨`);
                    } else {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                        button.style.background = '#666';
                        console.log(`❌ 비교 버튼 ${index + 1} 비활성화됨 (원본: ${!!window.originalAnalysis}, 연주: ${!!window.recordingAnalysis})`);
                    }
                });
            }

            // 유사도 계산 (0-100%)
            function calculateSimilarity(value1, value2, tolerance = 0) {
                if (value1 === 0 && value2 === 0) return 100;
                const maxValue = Math.max(value1, value2);
                if (maxValue === 0) return 100;
                
                const diff = Math.abs(value1 - value2);
                if (tolerance > 0 && diff <= tolerance) return 100;
                
                const similarity = Math.max(0, 100 - (diff / maxValue) * 100);
                return Math.round(similarity);
            }

            // AI 피드백 생성
            function generateAIFeedback(comparison) {
                const feedback = [];
                
                // 템포 피드백
                if (comparison.overall.tempoDiff > 10) {
                    if (comparison.overall.recordingTempo > comparison.overall.originalTempo) {
                        feedback.push({
                            type: 'rhythm',
                            level: 'warning',
                            message: `연주가 원본보다 ${comparison.overall.tempoDiff.toFixed(1)} BPM 빠릅니다. 조금 더 천천히 연주해보세요.`
                        });
                    } else {
                        feedback.push({
                            type: 'rhythm',
                            level: 'warning',
                            message: `연주가 원본보다 ${comparison.overall.tempoDiff.toFixed(1)} BPM 느립니다. 조금 더 빠르게 연주해보세요.`
                        });
                    }
                } else if (comparison.overall.tempoDiff <= 5) {
                    feedback.push({
                        type: 'rhythm',
                        level: 'success',
                        message: '훌륭해요! 템포가 원본과 거의 일치합니다.'
                    });
                }

                // 음정 피드백
                if (comparison.pitch.pitchDiff > 50) {
                    if (comparison.pitch.recordingPitch > comparison.pitch.originalPitch) {
                        feedback.push({
                            type: 'pitch',
                            level: 'warning',
                            message: `연주의 음정이 원본보다 ${comparison.pitch.pitchDiff.toFixed(1)} Hz 높습니다. 조금 더 낮게 연주해보세요.`
                        });
                    } else {
                        feedback.push({
                            type: 'pitch',
                            level: 'warning',
                            message: `연주의 음정이 원본보다 ${comparison.pitch.pitchDiff.toFixed(1)} Hz 낮습니다. 조금 더 높게 연주해보세요.`
                        });
                    }
                } else {
                    feedback.push({
                        type: 'pitch',
                        level: 'success',
                        message: '좋아요! 음정이 원본과 잘 맞습니다.'
                    });
                }

                // 볼륨 피드백
                if (comparison.waveform.rmsDiff > 0.1) {
                    if (comparison.waveform.recordingRMS > comparison.waveform.originalRMS) {
                        feedback.push({
                            type: 'waveform',
                            level: 'info',
                            message: '연주가 원본보다 조금 크게 들립니다. 조금 더 부드럽게 연주해보세요.'
                        });
                    } else {
                        feedback.push({
                            type: 'waveform',
                            level: 'info',
                            message: '연주가 원본보다 조금 작게 들립니다. 조금 더 강하게 연주해보세요.'
                        });
                    }
                }

                // 조 (키) 피드백
                if (!comparison.overall.keyMatch) {
                    feedback.push({
                        type: 'pitch',
                        level: 'error',
                        message: `연주한 조가 다릅니다. 원본: ${comparison.overall.originalKey}, 연주: ${comparison.overall.recordingKey}`
                    });
                }

                // 전체 평가
                const overallScore = Math.round((comparison.waveform.similarity + comparison.pitch.similarity + comparison.rhythm.accuracy) / 3);
                if (overallScore >= 90) {
                    feedback.push({
                        type: 'overall',
                        level: 'success',
                        message: `🎉 훌륭한 연주입니다! 원본과 ${overallScore}% 일치합니다.`
                    });
                } else if (overallScore >= 70) {
                    feedback.push({
                        type: 'overall',
                        level: 'info',
                        message: `👍 좋은 연주입니다! 원본과 ${overallScore}% 일치합니다. 조금만 더 연습하면 완벽해질 것 같아요.`
                    });
                } else {
                    feedback.push({
                        type: 'overall',
                        level: 'warning',
                        message: `💪 연습이 더 필요해요. 원본과 ${overallScore}% 일치합니다. 템포와 음정을 더 주의해서 연주해보세요.`
                    });
                }

                return feedback;
            }

            // 비교 결과 화면 표시
            function displayComparisonResults(comparison) {
                // 새로운 비교 결과 영역 생성 또는 기존 영역 업데이트
                let comparisonDiv = document.getElementById('comparisonResults');
                if (!comparisonDiv) {
                    comparisonDiv = document.createElement('div');
                    comparisonDiv.id = 'comparisonResults';
                    comparisonDiv.style.cssText = `
                        background: #16213e; 
                        border-radius: 12px; 
                        padding: 25px; 
                        margin: 20px 0; 
                        border: 2px solid #4a90e2;
                        max-width: 1000px;
                        margin-left: auto;
                        margin-right: auto;
                    `;
                    
                    // 연주 업로드 결과 다음에 삽입
                    const recordingUploadResults = document.getElementById('recordingUploadResults');
                    if (recordingUploadResults && recordingUploadResults.parentNode) {
                        recordingUploadResults.parentNode.insertBefore(comparisonDiv, recordingUploadResults.nextSibling);
                    } else {
                        document.querySelector('.container').appendChild(comparisonDiv);
                    }
                }

                const html = `
                    <div class="comparison-analysis">
                        <h2 style="text-align:center;color:#4a90e2;margin-bottom:25px;">
                            <i class="fas fa-balance-scale"></i>
                            원본 vs 연주 비교 분석
                        </h2>

                        <!-- 전체 요약 -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;margin-bottom:25px;">
                            <h3 style="color:#4ad991;margin-bottom:15px;">📊 전체 분석 결과</h3>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#ffb347;margin-bottom:8px;">템포 비교</h4>
                                    <p style="color:#e0e6ed;">원본: ${comparison.overall.originalTempo} BPM</p>
                                    <p style="color:#e0e6ed;">연주: ${comparison.overall.recordingTempo} BPM</p>
                                    <p style="color:${comparison.overall.tempoDiff <= 5 ? '#4ad991' : comparison.overall.tempoDiff <= 15 ? '#ffb347' : '#ff6b6b'};">
                                        차이: ${comparison.overall.tempoDiff.toFixed(1)} BPM
                                    </p>
                                </div>
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#7f8cff;margin-bottom:8px;">키 비교</h4>
                                    <p style="color:#e0e6ed;">원본: ${comparison.overall.originalKey}</p>
                                    <p style="color:#e0e6ed;">연주: ${comparison.overall.recordingKey}</p>
                                    <p style="color:${comparison.overall.keyMatch ? '#4ad991' : '#ff6b6b'};">
                                        ${comparison.overall.keyMatch ? '✅ 일치' : '❌ 불일치'}
                                    </p>
                                </div>
                                <div style="text-align:center;padding:15px;background:#0e0f1c;border-radius:8px;">
                                    <h4 style="color:#4ad991;margin-bottom:8px;">전체 유사도</h4>
                                    <p style="font-size:1.5em;font-weight:bold;color:${
                                        comparison.rhythm.accuracy >= 90 ? '#4ad991' : 
                                        comparison.rhythm.accuracy >= 70 ? '#ffb347' : '#ff6b6b'
                                    };">
                                        ${Math.round((comparison.waveform.similarity + comparison.pitch.similarity + comparison.rhythm.accuracy) / 3)}%
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 상세 비교 시각화 -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;margin-bottom:25px;">
                            <h3 style="color:#4ad991;margin-bottom:20px;">📈 상세 비교 시각화</h3>
                            
                            <!-- 파형 비교 -->
                            <div style="margin-bottom:25px;">
                                <h4 style="color:#4ad991;margin-bottom:10px;">
                                    <i class="fas fa-wave-square"></i>
                                    파형 비교 (유사도: ${comparison.waveform.similarity}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#4ad991;margin-bottom:5px;">원본 파형</p>
                                        <canvas id="comparisonOriginalWaveform" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #4ad991;"></canvas>
                                        <p style="font-size:0.9em;color:#4ad991;margin-top:5px;">RMS: ${comparison.waveform.originalRMS.toFixed(3)}</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#4ad991;margin-bottom:5px;">연주 파형</p>
                                        <canvas id="comparisonRecordingWaveform" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #4ad991;"></canvas>
                                        <p style="font-size:0.9em;color:#4ad991;margin-top:5px;">RMS: ${comparison.waveform.recordingRMS.toFixed(3)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 음정 비교 -->
                            <div style="margin-bottom:25px;">
                                <h4 style="color:#ffb347;margin-bottom:10px;">
                                    <i class="fas fa-music"></i>
                                    음정 비교 (유사도: ${comparison.pitch.similarity}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#ffb347;margin-bottom:5px;">원본 음정</p>
                                        <canvas id="comparisonOriginalPitch" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #ffb347;"></canvas>
                                        <p style="font-size:0.9em;color:#ffb347;margin-top:5px;">평균: ${comparison.pitch.originalPitch.toFixed(1)} Hz</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#ffb347;margin-bottom:5px;">연주 음정</p>
                                        <canvas id="comparisonRecordingPitch" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #ffb347;"></canvas>
                                        <p style="font-size:0.9em;color:#ffb347;margin-top:5px;">평균: ${comparison.pitch.recordingPitch.toFixed(1)} Hz</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 박자 비교 -->
                            <div style="margin-bottom:20px;">
                                <h4 style="color:#7f8cff;margin-bottom:10px;">
                                    <i class="fas fa-drum"></i>
                                    박자 비교 (정확도: ${Math.round(comparison.rhythm.accuracy)}%)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="text-align:center;">
                                        <p style="color:#7f8cff;margin-bottom:5px;">원본 박자</p>
                                        <canvas id="comparisonOriginalRhythm" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #7f8cff;"></canvas>
                                        <p style="font-size:0.9em;color:#7f8cff;margin-top:5px;">${comparison.overall.originalTempo} BPM</p>
                                    </div>
                                    <div style="text-align:center;">
                                        <p style="color:#7f8cff;margin-bottom:5px;">연주 박자</p>
                                        <canvas id="comparisonRecordingRhythm" width="320" height="80" style="width:100%;border-radius:6px;border:1px solid #7f8cff;"></canvas>
                                        <p style="font-size:0.9em;color:#7f8cff;margin-top:5px;">${comparison.overall.recordingTempo} BPM</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI 피드백 -->
                        <div style="background:#1a1b2e;border-radius:10px;padding:20px;">
                            <h3 style="color:#4ad991;margin-bottom:15px;">🤖 AI 피드백</h3>
                            <div class="feedback-list">
                                ${comparison.feedback.map(f => `
                                    <div style="
                                        background:${f.level === 'success' ? '#0d3d0d' : f.level === 'warning' ? '#3d2a0d' : f.level === 'error' ? '#3d0d0d' : '#0d1a3d'};
                                        border-left: 4px solid ${f.level === 'success' ? '#4ad991' : f.level === 'warning' ? '#ffb347' : f.level === 'error' ? '#ff6b6b' : '#7f8cff'};
                                        padding: 12px 15px;
                                        margin-bottom: 10px;
                                        border-radius: 6px;
                                    ">
                                        <span style="color:${f.level === 'success' ? '#4ad991' : f.level === 'warning' ? '#ffb347' : f.level === 'error' ? '#ff6b6b' : '#7f8cff'};font-weight:500;">
                                            ${f.type === 'rhythm' ? '🥁' : f.type === 'pitch' ? '🎵' : f.type === 'waveform' ? '📊' : '🎯'} 
                                        </span>
                                        <span style="color:#e0e6ed;">${f.message}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="text-align:center;margin-top:20px;color:#666;font-size:12px;">
                            <p><small>비교 분석 완료: ${new Date().toLocaleString()}</small></p>
                        </div>
                    </div>
                `;

                comparisonDiv.innerHTML = html;
                comparisonDiv.style.display = 'block';

                // 비교 시각화 그리기
                setTimeout(() => {
                    drawWaveform('comparisonOriginalWaveform', window.originalAnalysis.waveformData);
                    drawWaveform('comparisonRecordingWaveform', window.recordingAnalysis.waveformData);
                    drawPitch('comparisonOriginalPitch', window.originalAnalysis.pitchData);
                    drawPitch('comparisonRecordingPitch', window.recordingAnalysis.pitchData);
                    drawRhythm('comparisonOriginalRhythm', window.originalAnalysis.rhythmData);
                    drawRhythm('comparisonRecordingRhythm', window.recordingAnalysis.rhythmData);
                }, 100);

                // 비교 결과로 스크롤
                comparisonDiv.scrollIntoView({ behavior: 'smooth' });
                
                console.log('✅ 비교 결과 UI 표시 완료');
            }

            console.log('🎹 PianoAI Coach 초기화 완료!');
        });
    </script>
</body>
</html> 